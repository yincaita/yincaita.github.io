<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>glidedsky网站爬虫练习 | yincaiTA' Blog</title><meta name="keywords" content="Python,爬虫,glidedsky"><meta name="author" content="yincaiTA"><meta name="copyright" content="yincaiTA"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="爬虫基础-1 其次，关于_token，新开浏览器(无痕)会发现这个值是会变化的   思路：每次请求前先访问登陆界面获得token，再和email、password一起请求。这是一个公共的过程，封装成 env.py。 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505">
<meta property="og:type" content="article">
<meta property="og:title" content="glidedsky网站爬虫练习">
<meta property="og:url" content="https://lsycai.top/glidedsky/index.html">
<meta property="og:site_name" content="yincaiTA&#39; Blog">
<meta property="og:description" content="爬虫基础-1 其次，关于_token，新开浏览器(无痕)会发现这个值是会变化的   思路：每次请求前先访问登陆界面获得token，再和email、password一起请求。这是一个公共的过程，封装成 env.py。 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img.lsycai.top/cover/glidedsky.png">
<meta property="article:published_time" content="2021-06-15T11:03:49.000Z">
<meta property="article:modified_time" content="2022-04-12T14:37:12.000Z">
<meta property="article:author" content="yincaiTA">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="爬虫">
<meta property="article:tag" content="glidedsky">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.lsycai.top/cover/glidedsky.png"><link rel="shortcut icon" href="/self/images/tab_favicon.png"><link rel="canonical" href="https://lsycai.top/glidedsky/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"简","msgToSimplifiedChinese":"繁"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'glidedsky网站爬虫练习',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-04-12 22:37:12'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/self/css/atom-one-light.css"><link rel="stylesheet" href="/self/css/scroll-bar.css"><link rel="stylesheet" href="/self/css/h-title.css"><link rel="stylesheet" href="/self/css/some-style.css"><meta name="generator" content="Hexo 6.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/self/images/loading.gif" data-original="/self/images/author_avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">4</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://img.lsycai.top/cover/glidedsky.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">yincaiTA' Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">glidedsky网站爬虫练习</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-06-15T11:03:49.000Z" title="发表于 2021-06-15 19:03:49">2021-06-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-04-12T14:37:12.000Z" title="更新于 2022-04-12 22:37:12">2022-04-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%88%AC%E8%99%AB/">爬虫</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="glidedsky网站爬虫练习"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="爬虫基础-1"><a href="#爬虫基础-1" class="headerlink" title="爬虫基础-1"></a>爬虫基础-1</h1><p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/basic-1.1.png" alt="爬虫基础-1.1"></p>
<p>其次，关于<code>_token</code>，新开浏览器(无痕)会发现这个值是会变化的</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/basic-1.2.png" alt="爬虫基础-1.2"></p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/basic-1.3.png" alt="爬虫基础-1.3"></p>
<p>思路：每次请求前先访问登陆界面获得token，再和email、password一起请求。这是一个公共的过程，封装成 env.py。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">环境设置</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> re<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Env</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-comment"># 每秒获取个数 最多200 但是靠后的因为时间关系 多少会速度差些</span><br>    ip_each = <span class="hljs-number">30</span><br>    <span class="hljs-comment"># 请求数据</span><br>    login_data = &#123;<br>        <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;邮箱&quot;</span>,<br>        <span class="hljs-string">&quot;password&quot;</span>: <span class="hljs-string">&quot;密码&quot;</span>,<br>        <span class="hljs-string">&quot;_token&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>    &#125;<br>    <span class="hljs-comment"># api的url</span><br>    proxy_api_url = <span class="hljs-string">&quot;api_url xxx &amp;getnum=&quot;</span> + <span class="hljs-built_in">str</span>(ip_each)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 请求头</span><br>        self.headers = &#123;<br>            <span class="hljs-string">&quot;User-Agent&quot;</span>: <span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) &quot;</span><br>                          <span class="hljs-string">&quot;Chrome/89.0.4389.90 Safari/537.36 &quot;</span><br>        &#125;<br>        <span class="hljs-comment"># login_url</span><br>        self.login_url = <span class="hljs-string">&quot;http://www.glidedsky.com/login&quot;</span><br>        <span class="hljs-comment"># 使用session, 自动保存登陆后获取的cookie</span><br>        self.session = requests.session()<br><br>    <span class="hljs-comment"># 登陆获取 _token值</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">self</span>):<br>        response = self.session.get(self.login_url, headers=self.headers)<br>        <span class="hljs-comment"># 正则解析, 将_token值返回</span><br>        self.login_data[<span class="hljs-string">&quot;_token&quot;</span>] = re.search(<span class="hljs-string">&#x27;name=&quot;_token&quot; value=&quot;(.*?)&quot;&#x27;</span>, response.text).group(<span class="hljs-number">1</span>)<br>        <span class="hljs-comment"># 登陆数据齐备, 正式登陆</span><br>        self.session.post(self.login_url, data=self.login_data, headers=self.headers)<br>        <span class="hljs-comment"># print(self.login_data[&quot;_token&quot;])</span><br>        <span class="hljs-keyword">return</span> self.session<br><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        实时获取代理ip: 某宝找的1块测试, 1s最多获取200次api 这里获取60 感觉前面的速度快些</span><br><span class="hljs-string">        [&#x27;ip1:port1&#x27;, &#x27;ip2:port2&#x27;]</span><br><span class="hljs-string">        过期后用的华益云 ip数量计费</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_proxy</span>(<span class="hljs-params">self</span>):<br>        response = requests.get(self.proxy_api_url, self.headers)<br>        <span class="hljs-keyword">return</span> response.text.split(<span class="hljs-string">&quot;\r\n&quot;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    env = Env()<br>    <span class="hljs-comment"># env.login()</span><br><br>    <span class="hljs-built_in">print</span>(env.get_proxy())<br></code></pre></td></tr></table></figure>

<h2 id="第一题"><a href="#第一题" class="headerlink" title="第一题"></a>第一题</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">爬虫基础1</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> env <span class="hljs-keyword">import</span> Env<br><span class="hljs-keyword">from</span> lxml <span class="hljs-keyword">import</span> etree<br><br><span class="hljs-comment"># 调用封装的登陆环境</span><br>env = Env()<br>session = env.login()<br><br><span class="hljs-comment"># 有了token, cookie等信息, 就能访问爬虫一页面了</span><br>url = <span class="hljs-string">&quot;http://www.glidedsky.com/level/web/crawler-basic-1&quot;</span><br>response = session.get(url, headers=env.headers)<br><span class="hljs-comment"># 获取每一个数字框</span><br>html = etree.HTML(response.text)<br>div_list = html.xpath(<span class="hljs-string">&#x27;//div[@class=&quot;col-md-1&quot;]&#x27;</span>)<br><span class="hljs-comment"># 定义 和</span><br>total = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> div <span class="hljs-keyword">in</span> div_list:<br>    total += <span class="hljs-built_in">int</span>(div.xpath(<span class="hljs-string">&#x27;normalize-space(./text())&#x27;</span>))<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;结果是: <span class="hljs-subst">&#123;total&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure>



<h1 id="爬虫基础-2"><a href="#爬虫基础-2" class="headerlink" title="爬虫基础-2"></a>爬虫基础-2</h1><p>登陆同上，这次需要翻页，这就需要循环获取下一页的链接。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/basic-2.1.png" alt="爬虫基础-2.1"></p>
<p>每一页获取数据方式同<code>爬虫基础1</code>，只是xpath语法有差别。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">爬虫基础2</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> env <span class="hljs-keyword">import</span> Env<br><span class="hljs-keyword">from</span> lxml <span class="hljs-keyword">import</span> etree<br><span class="hljs-keyword">import</span> re<br><br><span class="hljs-comment"># 调用封装的登陆环境</span><br>env = Env()<br>session = env.login()<br><br><span class="hljs-comment"># 定义 和</span><br>total = <span class="hljs-number">0</span><br><span class="hljs-comment"># 这次需要循环遍历每一页</span><br>curr_page_url = <span class="hljs-string">&quot;http://www.glidedsky.com/level/web/crawler-basic-2?page=1&quot;</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    response = session.get(curr_page_url, headers=env.headers)<br>    <span class="hljs-comment"># 获取每一个数字框</span><br>    html = etree.HTML(response.text)<br>    div_list = html.xpath(<span class="hljs-string">&#x27;//div[@class=&quot;card-body&quot;]//div[@class=&quot;col-md-1&quot;]&#x27;</span>)<br><br>    <span class="hljs-keyword">for</span> div <span class="hljs-keyword">in</span> div_list:<br>        total += <span class="hljs-built_in">int</span>(div.xpath(<span class="hljs-string">&#x27;normalize-space(./text())&#x27;</span>))<br><br>    cur_page_num = re.search(<span class="hljs-string">&#x27;page=(\\d+)&#x27;</span>, curr_page_url).group(<span class="hljs-number">1</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;前<span class="hljs-subst">&#123;cur_page_num&#125;</span>页数字和为: <span class="hljs-subst">&#123;total&#125;</span>&quot;</span>)<br><br>    <span class="hljs-comment"># 是否还有下一页</span><br>    next_page_btn = html.xpath(<span class="hljs-string">&#x27;//ul[@class=&quot;pagination&quot;]/li[last()]&#x27;</span>)[<span class="hljs-number">0</span>]<br>    <span class="hljs-comment"># 如果下一页按钮有disabled样式, 就没有下一页</span><br>    <span class="hljs-keyword">if</span> next_page_btn.xpath(<span class="hljs-string">&#x27;contains(@class, &quot;disabled&quot;)&#x27;</span>):<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># 有下一页, 给下一页url赋值</span><br>        curr_page_url = next_page_btn.xpath(<span class="hljs-string">&#x27;./a/@href&#x27;</span>)[<span class="hljs-number">0</span>]<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;结果是: <span class="hljs-subst">&#123;total&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure>



<h1 id="IP屏蔽-1"><a href="#IP屏蔽-1" class="headerlink" title="IP屏蔽-1"></a>IP屏蔽-1</h1><p>先用奇怪的方法达到修改ip的目的，再进去查看下网页结构，把xpath先行记录一遍，后续有错再改。（代理获取网页内容也可）</p>
<p>结果是：页面结构和爬虫基础2相同。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/ip-mask-3.1.png" alt="IP屏蔽-3.1"></p>
<p>现在最重要的就是如何获取1000多个可用的代理ip了，我们去某宝随便找一个便宜的<code>高匿ip</code>。</p>
<p>在env.py的Env类中添加如下成员方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 每秒获取个数 最多200 但是靠后的因为时间关系 多少会速度差些</span><br>   ip_each = <span class="hljs-number">30</span><br>   <br>   <span class="hljs-comment"># api的url</span><br>   proxy_api_url = <span class="hljs-string">&quot;api_url&quot;</span> + <span class="hljs-built_in">str</span>(ip_each)<br>       <br>   <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">       实时获取代理ip: 某宝找的1块测试, 1s最多获取200次api 这里获取60 感觉前面的速度快些</span><br><span class="hljs-string">       [&#x27;ip1:port1&#x27;, &#x27;ip2:port2&#x27;]</span><br><span class="hljs-string">       过期后用的华益云 ip数量计费</span><br><span class="hljs-string">   &quot;&quot;&quot;</span><br>   <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_proxy</span>(<span class="hljs-params">self</span>):<br>       response = requests.get(self.proxy_api_url, self.headers)<br>       <span class="hljs-keyword">return</span> response.text.split(<span class="hljs-string">&quot;\r\n&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>现在将上个<code>爬虫基础2</code>的代码进行改造，添加每次更换一个代理进行请求。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">ip反爬1</span><br><span class="hljs-string">    结构和爬虫基础相同</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> env <span class="hljs-keyword">import</span> Env<br><span class="hljs-keyword">from</span> lxml <span class="hljs-keyword">import</span> etree<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> time<br><br><span class="hljs-comment"># 调用封装的登陆环境</span><br>env = Env()<br>session = env.login()<br><br><span class="hljs-comment"># 定义 和</span><br>total = <span class="hljs-number">0</span><br><br><span class="hljs-comment"># 当前页</span><br>curr_page = <span class="hljs-number">1</span><br><br><span class="hljs-comment"># 代理ip的索引, 因为每1秒只能获取最多200个ip</span><br>proxy_index = <span class="hljs-number">0</span><br><br><span class="hljs-comment"># 200个代理ip列表</span><br>proxy_list = env.get_proxy()<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-comment"># 这里采用代理 超时设置为0.6s 设置小一点 那么慢的代理ip就自动跳过了 但是又不能太小 毕竟代理比正常访问慢 跑完估计也得5-8分钟左右</span><br>    <span class="hljs-comment"># 如果报错/返回403页面就用下一个代理 注意代理的 键是http 写成大写代理无效</span><br>    <span class="hljs-keyword">try</span>:<br>        response = session.get(<span class="hljs-string">f&quot;http://www.glidedsky.com/level/web/crawler-ip-block-1?page=<span class="hljs-subst">&#123;curr_page&#125;</span>&quot;</span>,<br>                               headers=env.headers, timeout=<span class="hljs-number">0.3</span>, proxies=&#123;<span class="hljs-string">&quot;http&quot;</span>: proxy_list[proxy_index]&#125;)<br>        <span class="hljs-comment"># 页面响应403 则也应算错误</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-number">403</span> == response.status_code:<br>            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">f&quot;该代理已经用过: <span class="hljs-subst">&#123;proxy_list[proxy_index]&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-comment"># 直接使用下一个的proxy</span><br>        proxy_index += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> proxy_index &gt;= env.ip_each:<br>            proxy_list = env.get_proxy()<br>            <span class="hljs-comment"># *****</span><br>            proxy_index = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">continue</span><br><br>    <span class="hljs-comment"># 获取每一个数字框</span><br>    html = etree.HTML(response.text)<br>    div_list = html.xpath(<span class="hljs-string">&#x27;//div[@class=&quot;card-body&quot;]//div[@class=&quot;col-md-1&quot;]&#x27;</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span>*<span class="hljs-number">40</span>)<br>    <span class="hljs-keyword">for</span> div <span class="hljs-keyword">in</span> div_list:<br>        total += <span class="hljs-built_in">int</span>(div.xpath(<span class="hljs-string">&#x27;normalize-space(./text())&#x27;</span>))<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;前<span class="hljs-subst">&#123;curr_page&#125;</span>页数字和为: <span class="hljs-subst">&#123;total&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">if</span> curr_page &gt;= <span class="hljs-number">1000</span>:<br>        <span class="hljs-keyword">break</span><br>    curr_page += <span class="hljs-number">1</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;结果是: <span class="hljs-subst">&#123;total&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure>



<h1 id="IP屏蔽-2"><a href="#IP屏蔽-2" class="headerlink" title="IP屏蔽-2"></a>IP屏蔽-2</h1><p>因为每次请求都是用的新代理ip，代码同 <code>ip屏蔽1</code>题。</p>
<p>结果（多循环了一次，curr_page &gt;1000 之前没加上 &gt;&#x3D;，对结果没影响）：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/ip-mask-4.1.png" alt="IP屏蔽-4.1"></p>
<h1 id="字体反爬-1"><a href="#字体反爬-1" class="headerlink" title="字体反爬-1"></a>字体反爬-1</h1><p>看过题并分析过html代码的应该都清除，每次刷新源码中的数字都是变化的，而实际显示出的数字都没变化。<br>有心的同学应该比较过每次刷新网页后的base64串的值，它们都是不同的，说明base64串在这里承载了字体转化的功能。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-5.1.png" alt="刷新网页后的base64串比较"><br>所以我们需要对每次的base64串进行分析，在这里了解到了能将base64转化为<code>ttf</code>文件，再利用代码转为<code>xml</code>文件做分析。</p>
<p>我们在<code>浏览器</code>内(方便后期对比确认结果)，获取base64串，用代码将其转为 ttf 和 xml 文件。</p>
<blockquote>
<p><strong>数据采集过程</strong></p>
</blockquote>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-5.2.png" alt="打开无痕窗口"><br>进入页面后F12，搜索<code>base64</code>，进入界面复制值。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-5.3.png" alt="搜索"></p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-5.4.png" alt="复制base64串"></p>
<blockquote>
<p>代码验证base64的不唯一性  并  转化ttf、xml<br><strong>ttf_test.py</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">关于转码</span><br><span class="hljs-string">    https://blog.csdn.net/yishengzhiai005/article/details/80045042</span><br><span class="hljs-string">    python2中进行Base64编码和解码</span><br><span class="hljs-string">    python3不太一样：因为3.x中字符都为unicode编码，而b64encode函数的参数为byte类型，所以必须先转码。</span><br><span class="hljs-string">    </span><br><span class="hljs-string">测试base64转ttf、分析ttf、xml文件</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> env <span class="hljs-keyword">import</span> Env<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">from</span> fontTools.ttLib <span class="hljs-keyword">import</span> TTFont<br><br>env = Env()<br>env.login()<br>session = env.session<br><br>url = <span class="hljs-string">&quot;http://www.glidedsky.com/level/web/crawler-font-puzzle-1&quot;</span><br><br>response = session.get(url, headers=env.headers)<br><br><span class="hljs-comment"># base64_str = re.search(&#x27;base64,(.*?)[)]&#x27;, response.text).group(1)</span><br><br><span class="hljs-comment"># 打印base64 说明每次的base64都有不同之处</span><br><span class="hljs-comment"># print(base64_str)</span><br><span class="hljs-comment"># 解码(base64参数都是unicode编码后的串, 所以str先得encode), 解码针对的是base64_str编码成unicode后的bytes</span><br><br><span class="hljs-comment"># 直接用我们无痕浏览器复制下来的base64串</span><br>base64_str = <span class="hljs-string">&quot;自己补全&quot;</span><br>data = base64.b64decode(base64_str.encode())<br><span class="hljs-comment"># 现在的data依旧是unicode编码的bytes类型</span><br><br><span class="hljs-comment"># 写出为 .ttf</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;font-puzzle-1.ttf&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(data)<br><br><span class="hljs-comment"># 将font-puzzle-1.ttf转为xml文件</span><br>font = TTFont(<span class="hljs-string">&#x27;font-puzzle-1.ttf&#x27;</span>)<br>font.saveXML(<span class="hljs-string">&#x27;font-puzzle-1.xml&#x27;</span>)<br></code></pre></td></tr></table></figure>



<blockquote>
<p><strong>第一次获取base64串</strong></p>
</blockquote>
<p>将base64串赋值到代码中变量 <code>base64_str</code>，运行生成 ttf 和 xml。<br>将ttf用fontstore<a target="_blank" rel="noopener" href="http://font.qqe2.com/index.html">链接</a>（或fontcreator）打开，</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-5.5.png" alt="字体反爬-5.5"></p>
<p>fontstore打开如下图：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-5.6.png" alt="fontstore打开"><br>fontcreator打开如下：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-5.7.png" alt="字体反爬-5.7"><br>我们再打开 xml 进行分析，搜索<code>code</code>相关内容，发现就只有以下2处有效数据(和数字相关的数据)。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-5.8.png" alt="字体反爬-5.8"></p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-5.9.png" alt="字体反爬-5.9"></p>
<p>结合<code>xml中上面2图的映射关系</code>和<code>fontstore中的</code>将数据整理成表格：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-5.10.png" alt="字体反爬-5.10"><br>纸面分析完了，进行浏览器内容比较：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-5.11.png" alt="字体反爬-5.11"></p>
<p>比较浏览器显示：说明字体文件（ttf&#x2F;xml）中的cmap中的<font color=red>name值</font>唯一对应一个<font color=red>实际显示</font>。因为表格中，”zero” –&gt; 8，”one”  –&gt; 5 ……，只是我在图中用了数字表示。</p>
<blockquote>
<p><strong>第二次获取base64串</strong></p>
</blockquote>
<p>重开一个无痕浏览器，进行同样访问，获得一个新base64串，用代码（ttf_test.py）重新生成ttf和xml文件，fontstore<font color=red>重新</font>打开ttf文件。</p>
<p>现在先就可以不用再分析xml文件内容了，经过第一次观察，直接看<code>fontstore结果</code>即可，结果是一样的。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-5.12.png" alt="字体反爬-5.12"><br>重要结论：<font color=red>name对应code一直都没有改变的。</font>所以，源码改变，但是实际显示内容不变，肯定是 <code>code --&gt; 实际显示</code>  这一过程的映射发生了变化。正好GlyphOrder映射有所改变。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-5.13.png" alt="字体反爬-5.13"><br>下面是新一轮统计的表格：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-5.14.png" alt="字体反爬-5.14"></p>
<p>“7”，…..。</p>
<p>现在靠第二次纸面分析的结果，我们推测：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-5.15.png" alt="字体反爬-5.15"></p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-5.16.png" alt="字体反爬-5.16"></p>
<p>推测<font color=red>正确</font>。</p>
<blockquote>
<p><strong>思考</strong></p>
</blockquote>
<p>现在我们能从xml中获取<code>name --&gt; code</code> 的映射（这是不变的），那么 从 <code>name --&gt; 实际显示</code> 的映射怎么办呢?</p>
<p>从第二次测试中能得出：实际显示的改变就和<code>GlyphOrder</code>的变化有关（即ID和name的映射的改变）。</p>
<p>再加上实际显示的结果，我们比较2次测试，表格结果的区别：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-5.17.png" alt="字体反爬-5.17"><br>从xml文件中和<code>&quot;code&quot;</code>有关的部分就只有<code>GlyphOrder</code>和<code>cmap</code>，cma的name、code我们已经用了，也用了GlyphOrder中的name，还有GlyphOrder中的ID规律我们没考虑到。</p>
<p>我们观察上面2图，很轻松就能发现<mark class="hl-label 就等于">ID-1</mark> </p>
<blockquote>
<p><strong>实现</strong></p>
</blockquote>
<p>所以代码逻辑也有了：请求获取base64，转为tff再转为xml，lxml解析，（能构建cmap中 <code>name --&gt; code</code>，但我们只关心<code>name--&gt;ID</code>），再构建GlyphOrder中  <code>name --&gt; ID</code>的映射。得到了name，<strong>name其实就是浏览器源码中提起出来的数字，转化为ID，再减一，就成了真实数据了</strong>。但是name中 <code>&#39;zero&#39;</code>需要变为<code>0</code>，方便后期直接进行页面内容转化为真实结果。</p>
<blockquote>
<p>代码如下</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> env <span class="hljs-keyword">import</span> Env<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">from</span> fontTools.ttLib <span class="hljs-keyword">import</span> TTFont<br><span class="hljs-keyword">from</span> lxml <span class="hljs-keyword">import</span> etree<br><span class="hljs-keyword">import</span> io<br><br><span class="hljs-comment"># 数字-英语 映射</span><br>english_map = &#123;<br>    <span class="hljs-string">&#x27;0&#x27;</span>: <span class="hljs-string">&#x27;zero&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>: <span class="hljs-string">&#x27;one&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>: <span class="hljs-string">&#x27;two&#x27;</span>,<br>    <span class="hljs-string">&#x27;3&#x27;</span>: <span class="hljs-string">&#x27;three&#x27;</span>, <span class="hljs-string">&#x27;4&#x27;</span>: <span class="hljs-string">&#x27;four&#x27;</span>, <span class="hljs-string">&#x27;5&#x27;</span>: <span class="hljs-string">&#x27;five&#x27;</span>,<br>    <span class="hljs-string">&#x27;6&#x27;</span>: <span class="hljs-string">&#x27;six&#x27;</span>, <span class="hljs-string">&#x27;7&#x27;</span>: <span class="hljs-string">&#x27;seven&#x27;</span>, <span class="hljs-string">&#x27;8&#x27;</span>: <span class="hljs-string">&#x27;eight&#x27;</span>, <span class="hljs-string">&#x27;9&#x27;</span>: <span class="hljs-string">&#x27;nine&#x27;</span><br>&#125;<br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">将源码中的字符串转化为真实的数字</span><br><span class="hljs-string">    src_str: 如&#x27;231&#x27; --&gt; 567  &#x27;23&#x27; --&gt; 56  &#x27;1&#x27; --&gt; 7</span><br><span class="hljs-string">    digit_map: 源码数字 --&gt; 真实数字 的映射 &#123;&quot;zero&quot;: see_num1, &quot;one&quot;: see_num2, ...&#125;</span><br><span class="hljs-string">    返回: 真实数字</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_srcstr_realnum</span>(<span class="hljs-params">src_str, digit_map</span>):<br>    <span class="hljs-comment"># 分解出每一位字符 注意 join参数必须为字符串</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>(<span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-built_in">str</span>(digit_map[english_map[ch]]) <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> src_str))<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">获取从源码中的数字到见到的数字的映射</span><br><span class="hljs-string">    返回: 当前页响应, 当前页的数字映射</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_response_and_digitmap</span>(<span class="hljs-params">page</span>):<br>    url = <span class="hljs-string">f&quot;http://www.glidedsky.com/level/web/crawler-font-puzzle-1?page=<span class="hljs-subst">&#123;page&#125;</span>&quot;</span><br><br>    response = session.get(url, headers=env.headers)<br><br>    base64_str = re.search(<span class="hljs-string">&#x27;base64,(.*?)[)]&#x27;</span>, response.text).group(<span class="hljs-number">1</span>)<br><br>    <span class="hljs-comment"># 解码(base64参数都是unicode编码后的串, 所以str先得encode), 解码针对的是base64_str编码成unicode后的bytes</span><br>    data = base64.b64decode(base64_str.encode())<br>    <span class="hljs-comment"># 现在的data依旧是unicode编码的bytes类型, 转化为io流, 避免写文件过程</span><br>    fio = io.BytesIO(data)<br>    font = TTFont(fio)<br>    glyph_order = font.getGlyphOrder()<br>    <span class="hljs-comment"># 数字映射 &#123;&quot;源码中的数字&quot;: &quot;实际看到的数字&quot;, ...&#125;</span><br>    digit_map = &#123;&#125;<br>    <span class="hljs-comment"># 解析GlyphOrder中的&lt;GlyphID id=&quot;&quot; name=&quot;&quot;&gt; 并组成 &#123;&quot;zero&quot;: &quot;see_num1&quot;, &quot;one&quot;: &quot;see_num2&quot;, ...&#125;</span><br>    <span class="hljs-keyword">for</span> glyph_name <span class="hljs-keyword">in</span> glyph_order:<br>        digit_map[glyph_name] = <span class="hljs-built_in">str</span>(font.getGlyphID(glyph_name) - <span class="hljs-number">1</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;源码数字 -&gt; 可见数字: &#x27;</span>, digit_map)<br>    <span class="hljs-keyword">return</span> digit_map, response<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">获取当前页真实的数字和, 一次请求一页, 一页内的数字 映射不会变的</span><br><span class="hljs-string">    page: 第几页数据</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_page_sum</span>(<span class="hljs-params">page</span>):<br>    digit_map, response = get_response_and_digitmap(page)<br>    <span class="hljs-comment"># 获取每一个数字框</span><br>    html = etree.HTML(response.text)<br>    div_list = html.xpath(<span class="hljs-string">&#x27;//div[@class=&quot;card-body&quot;]//div[@class=&quot;col-md-1&quot;]&#x27;</span>)<br><br>    <span class="hljs-comment"># 每页和</span><br>    page_total = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> div <span class="hljs-keyword">in</span> div_list:<br>        <span class="hljs-comment"># 一个数字串</span><br>        s = <span class="hljs-built_in">str</span>(div.xpath(<span class="hljs-string">&#x27;normalize-space(./text())&#x27;</span>))<br>        <span class="hljs-comment"># 分别解析, 如&#x27;231&#x27; -&gt; 231</span><br>        page_total += parse_srcstr_realnum(s, digit_map)<br><br>    <span class="hljs-keyword">return</span> page_total<br><br><br>env = Env()<br>env.login()<br>session = env.session<br><br><span class="hljs-comment"># 总和</span><br>total = <span class="hljs-number">0</span><br><span class="hljs-comment"># 定义和</span><br><span class="hljs-keyword">for</span> page_num <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1001</span>):<br>    total += get_page_sum(page_num)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;前 <span class="hljs-subst">&#123;page_num&#125;</span> 页和为 <span class="hljs-subst">&#123;total&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure>



<h1 id="字体反爬-2"><a href="#字体反爬-2" class="headerlink" title="字体反爬-2"></a>字体反爬-2</h1><p>原理同<code>字体反爬1</code>，但是现在从浏览器获取的内容不是数字了，而是汉字，并且xml中camp的name值也并没有像 “zero”、”one”的提示了，所以之前存在的 english_map 现在需要由我们自己构建了，原来english_map是 “1” -&gt; “zero” 的映射（这我们是熟知的），但现在我们需要 “源码中汉字” -&gt; “name” 的映射。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-6.1.png" alt="字体反爬-6.1"></p>
<blockquote>
<p>测试get请求获取的内容，编码前和编码后的内容，并生成ttf和xml</p>
<p>用浏览器能得到base64和显示情况，分析  “源码汉字”  –&gt;  “实际显示” 的过程。</p>
</blockquote>
<p>测试代码如下（test_ttf.py）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">from</span> fontTools.ttLib <span class="hljs-keyword">import</span> TTFont<br><br><span class="hljs-comment"># 浏览器复制base64串 保持网页不刷新 分析同一页的数据</span><br>base64_str = <span class="hljs-string">&quot;浏览器源码里复制&quot;</span><br>data = base64.b64decode(base64_str.encode())<br><span class="hljs-comment"># 现在的data依旧是unicode编码的bytes类型</span><br><br><span class="hljs-comment"># 写出为 .ttf</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;font-puzzle-2.ttf&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(data)<br><br><span class="hljs-comment"># 将font-puzzle-2.ttf转为xml文件</span><br>font = TTFont(<span class="hljs-string">&#x27;font-puzzle-2.ttf&#x27;</span>)<br>font.saveXML(<span class="hljs-string">&#x27;font-puzzle-2.xml&#x27;</span>)<br></code></pre></td></tr></table></figure>



<p>用fontstore打开ttf文件，只分析 0 - 9。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-6.2.png" alt="字体反爬-6.2"></p>
<p>浏览器中实际显示为“零”的情况下：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-6.3.png" alt="字体反爬-6.3"></p>
<p>对应源码汉字为：“钡”，经过站长工具计算，“钡”的unicode编码为：”\u94a1”</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-6.4.png" alt="字体反爬-6.4"></p>
<p>我们再在xml文件中搜索“钡”的unicode编码，结合xml中cmap的内容，我们直接搜索”uni94a1”，总共2个结果。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-6.5.png" alt="字体反爬-6.5"></p>
<p>在浏览器中实际显示为“①”的情况下，</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-6.6.png" alt="字体反爬-6.6"></p>
<p>而“成”字对应的unicode编码为“\u6210”，参照cmap中name的值，我们在xml中搜索“uni6210”。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-6.7.png" alt="字体反爬-6.7"></p>
<p>根据以上2次测试，并根据<code>字体反爬1</code>的结果，很明显能看出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">name = &quot;uni&quot; + &quot;源码汉字的unicode编码 去除\u&quot;<br>根据这个name对应的ID，再减1，结果就是实际的数字。<br></code></pre></td></tr></table></figure>



<blockquote>
<p>代码逻辑</p>
</blockquote>
<p>先根据GlyphOrder构建 {“name1”: “id”, “name2”, “id2”…} 的字典，之后再获取到”源码汉字”，将汉字进行切割后，取每一位的unicode码（就是name），以unicode码为键，从字典中取id，id再减1就是用户看到的数字。</p>
<blockquote>
<p>代码</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> env <span class="hljs-keyword">import</span> Env<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">from</span> fontTools.ttLib <span class="hljs-keyword">import</span> TTFont<br><span class="hljs-keyword">from</span> lxml <span class="hljs-keyword">import</span> etree<br><span class="hljs-keyword">import</span> io<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">将源码中的汉字转化为真实的数字</span><br><span class="hljs-string">    src_str: 如&#x27;随成成&#x27; --&gt; 211</span><br><span class="hljs-string">    uni_map: 源码汉字 --&gt; 真实数字 的映射 &#123;&quot;成&quot;: 1, &quot;随&quot;: 2, ...&#125;</span><br><span class="hljs-string">    返回: 真实数字</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_srcstr_realnum</span>(<span class="hljs-params">src_str, uni_map</span>):<br>    arr = []<br>    <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> src_str:<br>        <span class="hljs-comment"># 每个ch都是一个汉字, 将汉字转为unicode编码, 去除串首的\u即为需要的编码</span><br>        uni = ch.encode(<span class="hljs-string">&#x27;unicode-escape&#x27;</span>).decode()<br>        code = uni.replace(<span class="hljs-string">&#x27;\\u&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>        arr.append(uni_map[code])<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>(<span class="hljs-string">&#x27;&#x27;</span>.join(arr))<br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">获取从源码中的汉字到见到的数字的映射</span><br><span class="hljs-string">    返回: 当前页响应, name(unicode去除&#x27;uni&#x27;)-&gt;真实数字 的映射 如, (response, &#123;&#x27;7bd9&#x27;: &#x27;0&#x27;, &#x27;9716&#x27;: &#x27;1&#x27;, ...&#125;)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_response_and_unimap</span>(<span class="hljs-params">page</span>):<br>    url = <span class="hljs-string">f&quot;http://www.glidedsky.com/level/web/crawler-font-puzzle-2?page=<span class="hljs-subst">&#123;page&#125;</span>&quot;</span><br><br>    response = session.get(url, headers=env.headers)<br><br>    base64_str = re.search(<span class="hljs-string">&#x27;base64,(.*?)[)]&#x27;</span>, response.text).group(<span class="hljs-number">1</span>)<br><br>    <span class="hljs-comment"># 解码(base64参数都是unicode编码后的串, 所以str先得encode), 解码针对的是base64_str编码成unicode后的bytes</span><br>    data = base64.b64decode(base64_str.encode())<br><br>    <span class="hljs-comment"># 现在的data依旧是unicode编码的bytes类型, 转化为io流, 避免写文件过程</span><br>    fio = io.BytesIO(data)<br>    font = TTFont(fio)<br>    glyph_order = font.getGlyphOrder()<br>    <span class="hljs-comment"># xml中：name-&gt;ID映射 &#123;&quot;unicode&quot;: &quot;id-1&quot;, ...&#125; 注意这里的unicode最好把前缀uni去掉, 并字母小写化</span><br>    name_id_map = &#123;&#125;<br>    <span class="hljs-comment"># 解析GlyphOrder中的&lt;GlyphID id=&quot;&quot; name=&quot;&quot;&gt; 并组成 &#123;&quot;unicode1&quot;: &quot;see_num1&quot;, &quot;unicode2&quot;: &quot;see_num2&quot;, ...&#125;</span><br>    <span class="hljs-keyword">for</span> glyph_name <span class="hljs-keyword">in</span> glyph_order:<br>        name_id_map[<span class="hljs-built_in">str</span>(glyph_name).replace(<span class="hljs-string">&#x27;uni&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>).lower()] = <span class="hljs-built_in">str</span>(font.getGlyphID(glyph_name) - <span class="hljs-number">1</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;源码汉字unicode码 -&gt; 可见数字: &#x27;</span>, name_id_map)<br>    <span class="hljs-keyword">return</span> name_id_map, response<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">获取当前页真实的数字和, 一次请求一页, 一页内的数字 映射不会变的</span><br><span class="hljs-string">    page: 第几页数据</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_page_sum</span>(<span class="hljs-params">page</span>):<br>    uni_map, response = get_response_and_unimap(page)<br>    <span class="hljs-comment"># 获取每一个数字框</span><br>    html = etree.HTML(response.text)<br>    div_list = html.xpath(<span class="hljs-string">&#x27;//div[@class=&quot;card-body&quot;]//div[@class=&quot;col-md-1&quot;]&#x27;</span>)<br><br>    <span class="hljs-comment"># 每页和</span><br>    page_total = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> div <span class="hljs-keyword">in</span> div_list:<br>        <span class="hljs-comment"># 一个数字串</span><br>        s = <span class="hljs-built_in">str</span>(div.xpath(<span class="hljs-string">&#x27;normalize-space(./text())&#x27;</span>))<br>        <span class="hljs-comment"># 分别解析, 如&#x27;231&#x27; -&gt; 231</span><br>        page_total += parse_srcstr_realnum(s, uni_map)<br><br>    <span class="hljs-keyword">return</span> page_total<br><br><br>env = Env()<br>env.login()<br>session = env.session<br><br><span class="hljs-comment"># 总和</span><br>total = <span class="hljs-number">0</span><br><span class="hljs-comment"># 定义和</span><br><span class="hljs-keyword">for</span> page_num <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1001</span>):<br>    total += get_page_sum(page_num)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;前 <span class="hljs-subst">&#123;page_num&#125;</span> 页和为 <span class="hljs-subst">&#123;total&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure>



<p>上面的思路及代码其实有误，会在从 uni_map 中取值的时候会报错(KeyError)。</p>
<p>修改代码为如下，进行调试：</p>
<p>①：出错位置添加try…except</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_srcstr_realnum</span>(<span class="hljs-params">src_str, uni_map</span>):<br>    arr = []<br>    <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> src_str:<br>        <span class="hljs-comment"># 每个ch都是一个汉字, 将汉字转为unicode编码, 去除串首的\u即为需要的编码</span><br>        uni = ch.encode(<span class="hljs-string">&#x27;unicode-escape&#x27;</span>).decode()<br>        code = uni.replace(<span class="hljs-string">&#x27;\\u&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>        <span class="hljs-keyword">try</span>:<br>            arr.append(uni_map[code])<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(e)<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>(<span class="hljs-string">&#x27;&#x27;</span>.join(arr))<br></code></pre></td></tr></table></figure>

<p>②：获取response之后，我们添加将base64写入ttf和xml的过程。（目的是保证出错时我们能查看xml，分析为什么没有对应的unicode编码的name值）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 解码(base64参数都是unicode编码后的串, 所以str先得encode), 解码针对的是base64_str编码成unicode后的bytes</span><br>    data = base64.b64decode(base64_str.encode())<br>    <span class="hljs-comment"># 写出为 .ttf</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./font-puzzle-test2/font-puzzle-2.ttf&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        f.write(data)<br>    <span class="hljs-comment"># 将font-puzzle-2.ttf转为xml文件</span><br>    font = TTFont(<span class="hljs-string">&#x27;./font-puzzle-test2/font-puzzle-2.ttf&#x27;</span>)<br>    font.saveXML(<span class="hljs-string">&#x27;./font-puzzle-test2/font-puzzle-2.xml&#x27;</span>)<br><br>    <span class="hljs-comment"># 现在的data依旧是unicode编码的bytes类型, 转化为io流, 避免写文件过程</span><br>    fio = io.BytesIO(data)<br>    font = TTFont(fio)<br>    glyph_order = font.getGlyphOrder()<br></code></pre></td></tr></table></figure>

<p>开始调试：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-6.8.png" alt="字体反爬-6.8"></p>
<p>这时数据已经刷新到ttf、xml文件中了，我们进xml文件进行查看：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-6.9.png" alt="字体反爬-6.9"></p>
<p>最后需要特别注意的是：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/font-non-6.10.png" alt="字体反爬-6.10"></p>
<blockquote>
<p>修改后的代码</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> env <span class="hljs-keyword">import</span> Env<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">from</span> fontTools.ttLib <span class="hljs-keyword">import</span> TTFont<br><span class="hljs-keyword">from</span> lxml <span class="hljs-keyword">import</span> etree<br><span class="hljs-keyword">import</span> io<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">将源码中的汉字转化为真实的数字</span><br><span class="hljs-string">    src_str: 如&#x27;随成成&#x27; --&gt; 211</span><br><span class="hljs-string">    uni_map: 源码汉字 --&gt; 真实数字 的映射 &#123;&quot;成&quot;: 1, &quot;随&quot;: 2, ...&#125;</span><br><span class="hljs-string">    返回: 真实数字</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_srcstr_realnum</span>(<span class="hljs-params">src_str, uni_map</span>):<br>    arr = []<br>    <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> src_str:<br>        <span class="hljs-comment"># 每个ch都是一个汉字, 将汉字转为unicode编码, 去除串首的\u即为需要的编码</span><br>        uni = ch.encode(<span class="hljs-string">&#x27;unicode-escape&#x27;</span>).decode()<br>        code = uni.replace(<span class="hljs-string">&#x27;\\u&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>        arr.append(uni_map[code])<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>(<span class="hljs-string">&#x27;&#x27;</span>.join(arr))<br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">获取从源码中的汉字到见到的数字的映射</span><br><span class="hljs-string">    返回: 当前页响应, name(unicode去除&#x27;uni&#x27;)-&gt;真实数字 的映射 如, (response, &#123;&#x27;7bd9&#x27;: &#x27;0&#x27;, &#x27;9716&#x27;: &#x27;1&#x27;, ...&#125;)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_response_and_unimap</span>(<span class="hljs-params">page</span>):<br>    url = <span class="hljs-string">f&quot;http://www.glidedsky.com/level/web/crawler-font-puzzle-2?page=<span class="hljs-subst">&#123;page&#125;</span>&quot;</span><br><br>    response = session.get(url, headers=env.headers)<br><br>    base64_str = re.search(<span class="hljs-string">&#x27;base64,(.*?)[)]&#x27;</span>, response.text).group(<span class="hljs-number">1</span>)<br><br>    <span class="hljs-comment"># 解码(base64参数都是unicode编码后的串, 所以str先得encode), 解码针对的是base64_str编码成unicode后的bytes</span><br>    data = base64.b64decode(base64_str.encode())<br><br>    <span class="hljs-comment"># 现在的data依旧是unicode编码的bytes类型, 转化为io流, 避免写文件过程</span><br>    fio = io.BytesIO(data)<br>    font = TTFont(fio)<br>    glyph_order = font.getGlyphOrder()<br>    <span class="hljs-comment"># cmap的结构 &#123; code: name, ... &#125;  注意: cmap中的code是10进制</span><br>    cmap = font.getBestCmap()<br>    name_id_map = &#123;&#125;<br>    <span class="hljs-comment"># 解析GlyphOrder中的&lt;GlyphID id=&quot;&quot; name=&quot;&quot;&gt; 并组成 &#123; &quot;name&quot;: &quot;id-1&quot;... &#125;</span><br>    <span class="hljs-keyword">for</span> glyph_name <span class="hljs-keyword">in</span> glyph_order:<br>        <span class="hljs-comment"># 现在还只是 name: id 映射</span><br>        name_id_map[glyph_name] = <span class="hljs-built_in">str</span>(font.getGlyphID(glyph_name) - <span class="hljs-number">1</span>)<br>    <span class="hljs-comment"># 定义 code_id_map &#123;code: id, ...&#125;</span><br>    code_id_map = &#123;&#125;<br>    <span class="hljs-comment"># 遍历cmap, 得到 code_ip_map &#123;code: id&#125;</span><br>    <span class="hljs-keyword">for</span> code <span class="hljs-keyword">in</span> cmap:<br>        <span class="hljs-comment"># 将code转化为16进制</span><br>        code_id_map[<span class="hljs-built_in">hex</span>(code).replace(<span class="hljs-string">&#x27;0x&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)] = name_id_map[cmap[code]]<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;源码汉字unicode码 -&gt; 可见数字: &#x27;</span>, code_id_map)<br>    <span class="hljs-keyword">return</span> code_id_map, response<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">获取当前页真实的数字和, 一次请求一页, 一页内的数字 映射不会变的</span><br><span class="hljs-string">    page: 第几页数据</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_page_sum</span>(<span class="hljs-params">page</span>):<br>    uni_map, response = get_response_and_unimap(page)<br>    <span class="hljs-comment"># 获取每一个数字框</span><br>    html = etree.HTML(response.text)<br>    div_list = html.xpath(<span class="hljs-string">&#x27;//div[@class=&quot;card-body&quot;]//div[@class=&quot;col-md-1&quot;]&#x27;</span>)<br><br>    <span class="hljs-comment"># 每页和</span><br>    page_total = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> div <span class="hljs-keyword">in</span> div_list:<br>        <span class="hljs-comment"># 一个数字串</span><br>        s = <span class="hljs-built_in">str</span>(div.xpath(<span class="hljs-string">&#x27;normalize-space(./text())&#x27;</span>))<br>        <span class="hljs-comment"># 分别解析, 如&#x27;231&#x27; -&gt; 231</span><br>        page_total += parse_srcstr_realnum(s, uni_map)<br><br>    <span class="hljs-keyword">return</span> page_total<br><br><br>env = Env()<br>env.login()<br>session = env.session<br><br><span class="hljs-comment"># 总和</span><br>total = <span class="hljs-number">0</span><br><span class="hljs-comment"># 定义和</span><br><span class="hljs-keyword">for</span> page_num <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1001</span>):<br>    total += get_page_sum(page_num)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;前 <span class="hljs-subst">&#123;page_num&#125;</span> 页和为 <span class="hljs-subst">&#123;total&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure>



<h1 id="CSS反爬-1"><a href="#CSS反爬-1" class="headerlink" title="CSS反爬-1"></a>CSS反爬-1</h1><p>每次刷新class都会重置，挑其中一次分析，每次分析的时候的css都要匹配本次显示的页面。</p>
<blockquote>
<p>以下分析有错！①可以选择不看，直接看错误分析 + 重新讨论。②选择看错误的分类讨论，看下如何犯错的。</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># 分类讨论(取了少数几个例子):</span><br><br>  ## div.col-md-1 内只有一个div(::before) 直接获取content即为具体内容<br><span class="hljs-code">    .Lg20BXy &#123; float:left &#125; .Lg20BXy:before &#123; content:&quot;256&quot; &#125; .Lg20BXy &#123; letter-spacing:0.4em &#125;</span><br><span class="hljs-code"></span><br>  ## div.col-md-1 内有4个div 有1个div的class为透明 如源码中为 9 6 7 2  实际显示为 276<br><span class="hljs-code">    9: .mk0GYspY &#123; float:left &#125; .mk0GYspY &#123; width:1em &#125; .mk0GYspY &#123; margin-right:-1em &#125;   .mk0GYspY &#123; opacity:0 &#125;</span><br><span class="hljs-code">    6: .kXr1Xjjpn &#123; position:relative &#125; .kXr1Xjjpn &#123; float:left &#125; .kXr1Xjjpn &#123; width:1em &#125; .kXr1Xjjpn &#123; left:2em &#125;</span><br><span class="hljs-code">    7: .Miuk2yGt &#123; float:left &#125;  .Miuk2yGt &#123; width:1em &#125;</span><br><span class="hljs-code">    2: .sX3iaG &#123; position:relative &#125; .sX3iaG &#123; float:left &#125; .sX3iaG &#123; width:1em &#125; .sX3iaG &#123; left:-2em &#125;</span><br><span class="hljs-code">  规律：顺序遍历, left:2em &gt; 0 就在&#x27;&#x27;末尾插入, left:-2em &lt; 0 就在 &#x27;&#x27;开头插入, 不存在&#x27;left:&#x27;和&#x27;opacity:0&#x27;, 就直接保持&#x27;&#x27;末尾插入</span><br><span class="hljs-code"></span><br>  ## div.col-md-1 内有3个div(正常情况) 如源码中为 2 9 4  实际显示为294, 这种直接提取即可<br><span class="hljs-code">    2: .pRwyq22qBP &#123; float:left &#125; .pRwyq22qBP &#123; width:1em &#125;</span><br><span class="hljs-code">    9: .fyM23XHiCE &#123; float:left &#125; .fyM23XHiCE &#123; width:1em &#125;</span><br><span class="hljs-code">    4: .BTYOy24xKA &#123; float:left &#125; .BTYOy24xKA &#123; width:1em &#125;</span><br><span class="hljs-code">  规律: 按照第二种情况即可（相当于第二种情况中: 所有数字都是 7 ）</span><br><span class="hljs-code"></span><br>  ## div.col-md-1 内有2个div 有一个div<span class="hljs-strong">**包含数字**</span>但会设置完全透明，另一个div使用::before添加content, 这个div的情况就和第1种情况相同了<br></code></pre></td></tr></table></figure>

<p>综上，①和④可以合并为，div.col-md-1内部只要有div.xpath(‘.&#x2F;div&#x2F;text()’)为空值，那么这个div内部就必定是使用了伪元素选择器，我们就能直接获取content。</p>
<p>②和③也可以合并：②不管透明的那个元素后，就变为了③这种情况了。</p>
<p>至于生成的style直接从源码的&lt;style&gt;中获取即可，用正则验证具体的值存不存在。</p>
<blockquote>
<p> 之前考虑有错😭，例子太片面，下意识认为是“子绝父相”，以倍数获取自生位置，实际错误很大！！！！！！。</p>
</blockquote>
<p>看以下例子：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/css-non-7.1.png" alt="CSS反爬-7.1"></p>
<p>现在才认识到相对定位的问题。</p>
<p>现在开始重新分析：</p>
<ol>
<li>首先得认识到，div包含四个子div和包含三个子div是相同的，区别仅是它存在<code>margin-right</code>和<code>opacity</code>的区别（个人觉得等同于：display: none;），只不过得<mark class="hl-label green">注意</mark> 这个透明元素的位置，本题中一直都是处于div的第一个，所以不会影响到<mark class="hl-label green">之后三个div个顺序排列</mark> 。</li>
</ol>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/css-non-7.2.png" alt="CSS反爬-7.2"></p>
<ol start="2">
<li>还发现有的div，有position: relative，有的div没有。</li>
</ol>
<p>这是都有的：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/css-non-7.3.png" alt="CSS反爬-7.3"></p>
<p>这是存在没有的：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/css-non-7.4.png" alt="CSS反爬-7.4"></p>
<p>现在可以看出：div.col-md-1的孩子div的顺序就是原始顺序，这个顺序加上position: relative; left: xem 之后，就变为了新顺序，当然，这个过程中，不存在position: relative 样式的就保留原位置。</p>
<ol start="3">
<li>孩子为4个div的同理，第一个div因为是隐形的，当作没看见即可，同样也当3个div处理，<mark class="hl-label blue">但是</mark> ，在隐形元素之后位置的元素得位置得提前一个。（如果它之前有2个隐形元素，那么它的index也得提前2，这才是最初排除隐形元素之后，该元素应该在的位置）。</li>
<li>伪元素选择器情况：</li>
</ol>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/css-non-7.5.png" alt="CSS反爬-7.5"></p>
<mark class="hl-label green">补充</mark> : 过程中报错，之后还发现了值div.col-md-1的孩子存在2个的情况，都是有效数字，请注意。

<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/css-non-7.6.png" alt="CSS反爬-7.6"></p>
<blockquote>
<p>修正代码</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">css反爬-1</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> env <span class="hljs-keyword">import</span> Env<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">from</span> lxml <span class="hljs-keyword">import</span> etree<br><br>env = Env()<br>env.login()<br>session = env.session<br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">判断一个元素是否为透明元素</span><br><span class="hljs-string">    clazz: 该div的class</span><br><span class="hljs-string">    style: 页面总style层叠样式表</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">is_opacity</span>(<span class="hljs-params">clazz, style</span>):<br>    opacity = re.search(clazz + <span class="hljs-string">&#x27; \\&#123; opacity:0 \\&#125;&#x27;</span>, style)<br>    <span class="hljs-keyword">return</span> opacity <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">解析 div.col-md-1 这个div, 返回真实数据(的字符串形式)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_div</span>(<span class="hljs-params">div, style, test_text</span>):<br>    children = div.xpath(<span class="hljs-string">&#x27;./div&#x27;</span>)<br>    <span class="hljs-comment"># 伪元素选择器情况: 因为页面每个div中都是要么包含一个数字、要么为空值, 所以xpath(&#x27;text()&#x27;)得到的结果的列表长度无非就是 0或1, 0表示没有内容</span><br>    <span class="hljs-keyword">for</span> index, child <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(children):<br>        <span class="hljs-comment"># 长度为0 说明这个div就是 &lt;div&gt;::before&lt;/div&gt;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(child.xpath(<span class="hljs-string">&#x27;./text()&#x27;</span>)) == <span class="hljs-number">0</span>:<br>            <span class="hljs-comment"># 从style样式表中将 child 这个div的class值对应的 content 给取出来  如: UFihK6LyIh:before &#123; content:&quot;240&quot; &#125; 将240找出</span><br>            <span class="hljs-keyword">return</span> re.search(child.attrib[<span class="hljs-string">&#x27;class&#x27;</span>] + <span class="hljs-string">&#x27;:before \\&#123; content:&quot;(\\d+)&quot; \\&#125;&#x27;</span>, style).group(<span class="hljs-number">1</span>)<br><br>    <span class="hljs-comment"># 接下来是孩子有3/4个的处理 注意: 在隐形元素之后出现的div元素它的index都得减去它之前隐形元素出现的个数, 才是该div的初始位置</span><br>    opacity_count = <span class="hljs-number">0</span><br>    <span class="hljs-comment"># res装最终结果 最多之支持4位数字</span><br>    res = [-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>]<br>    <span class="hljs-comment"># index能记录当前div在源码中的索引</span><br>    <span class="hljs-keyword">for</span> index, child <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(children):<br>        <span class="hljs-comment"># 类名</span><br>        clazz = child.attrib[<span class="hljs-string">&#x27;class&#x27;</span>]<br><br>        <span class="hljs-comment"># 判断当前元素是否为透明元素</span><br>        <span class="hljs-keyword">if</span> is_opacity(clazz, style):<br>            opacity_count += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-comment"># 非透明元素, 先看是否有position: relative</span><br>        relative = re.search(clazz + <span class="hljs-string">&#x27; \\&#123; position:relative \\&#125;&#x27;</span>, style)<br><br>        <span class="hljs-comment"># 当前div的值</span><br>        val = child.xpath(<span class="hljs-string">&#x27;./text()&#x27;</span>)[<span class="hljs-number">0</span>]<br>        <span class="hljs-comment"># 不存在的话定位, 就是原位置, 但是得刨去隐藏元素站的位置</span><br>        <span class="hljs-keyword">if</span> relative <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            res[index - opacity_count] = val<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># 存在定位就使用当前index加上left:xem 的值, 先获取left:xem  注意search (:?)</span><br>            offset = re.search(clazz + <span class="hljs-string">&#x27; \\&#123; left:(-?\\d)em \\&#125;&#x27;</span>, style).group(<span class="hljs-number">1</span>)<br>            res[index + <span class="hljs-built_in">int</span>(offset) - opacity_count] = val<br><br>    <span class="hljs-comment"># try:</span><br>    r = <span class="hljs-string">&#x27;&#x27;</span>.join([i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> res <span class="hljs-keyword">if</span> i != -<span class="hljs-number">1</span>])<br>    <span class="hljs-comment"># except Exception as e:</span><br>    <span class="hljs-comment">#     print(e)</span><br>    <span class="hljs-keyword">return</span> r<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">获取每一页数字和</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_page_sum</span>(<span class="hljs-params">page_num</span>):<br>    url = <span class="hljs-string">f&quot;http://www.glidedsky.com/level/web/crawler-css-puzzle-1?page=<span class="hljs-subst">&#123;page_num&#125;</span>&quot;</span><br>    response = session.get(url, headers=env.headers)<br>    html = etree.HTML(response.text)<br><br>    div_list = html.xpath(<span class="hljs-string">&#x27;//div[@class=&quot;card-body&quot;]//div[@class=&quot;col-md-1&quot;]&#x27;</span>)<br>    <span class="hljs-comment"># 浏览器中生成的样式</span><br>    style = html.xpath(<span class="hljs-string">&#x27;normalize-space(//style/text())&#x27;</span>)<br>    <span class="hljs-comment"># 每页和</span><br>    page_total = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> div <span class="hljs-keyword">in</span> div_list:<br>        <span class="hljs-comment"># 解析div</span><br>        page_total += <span class="hljs-built_in">int</span>(parse_div(div, style, response.text))<br>    <span class="hljs-keyword">return</span> page_total<br><br><br><span class="hljs-comment"># 总和</span><br>total = <span class="hljs-number">0</span><br><span class="hljs-comment"># 定义和</span><br><span class="hljs-keyword">for</span> page_num <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1001</span>):<br>    total += get_page_sum(page_num)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;前 <span class="hljs-subst">&#123;page_num&#125;</span> 页和为 <span class="hljs-subst">&#123;total&#125;</span>&#x27;</span>)<br><br></code></pre></td></tr></table></figure>



<h1 id="雪碧图反爬-1"><a href="#雪碧图反爬-1" class="headerlink" title="雪碧图反爬-1"></a>雪碧图反爬-1</h1><p>页面结构全是 <code>div.col-md-1</code> 中包含2&#x2F;3个div，class都是随机串 + ‘ sprite’， 而’sprite’这个样式的<code>background-image: url()</code>包含base64串。</p>
<p>多刷新几次网页可以发现每次雪碧图中每个数字大小有差异，那么它<mark class="hl-label orange">background-position-x</mark> 的值就有一定差异，可以观察到同一个数字偏移的’x’值相同，并且因为原图片中数字都是从左到右从小到大排列的，我们可以获取当前页所有携带’sprite’样式的div，每一个div都有一个随机的class，如 ‘qaz’ 它的position-x为-12，’wsx’它的position-x为-23，’edc’的postion-x为0。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;qaz&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-12</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;wsx&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-23</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;edc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br><span class="hljs-punctuation">&#125;</span><br>↓<br><span class="hljs-punctuation">[</span> (<span class="hljs-string">&quot;qaz&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-12</span>)<span class="hljs-punctuation">,</span> (<span class="hljs-string">&quot;wsx&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-23</span>)<span class="hljs-punctuation">,</span> (<span class="hljs-string">&quot;edc&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span>) <span class="hljs-punctuation">]</span><br><br>d_order = sorted(字典.items()<span class="hljs-punctuation">,</span>key=lambda x<span class="hljs-punctuation">:</span>x<span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>reverse=True)<br>或者<br>列表.sort(key=lambda x<span class="hljs-punctuation">:</span>x<span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> reverse=True)  # 这个列表是上面 ↓ 的那个<br></code></pre></td></tr></table></figure>

<p>将值进行顺序排列，得到</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">[</span> <span class="hljs-string">&quot;edc&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;qaz&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;wsx&quot;</span> <span class="hljs-punctuation">]</span><br>或者<br><span class="hljs-punctuation">[</span> (<span class="hljs-string">&quot;edc&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span>)<span class="hljs-punctuation">,</span> (<span class="hljs-string">&quot;qaz&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-12</span>)<span class="hljs-punctuation">,</span> (<span class="hljs-string">&quot;wsx&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-23</span>) <span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure>

<p>那么接下来再顺序解析每个div时，就能根据它的<strong>class</strong>拿到对应的<strong>数字</strong>了。</p>
<blockquote>
<p>顺序排列取索引为数字的思维出了点问题，因为之前只注意到了相同数字的 postion-x 是相同的，但是没注意到尽管 position-x 想通了，但是它们的 class 依旧不是同一个！！！</p>
</blockquote>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-8.1.png" alt="雪碧图反爬-8.1"></p>
<p>重新考虑如下结构（<mark class="hl-label orange">qaz</mark> 和<mark class="hl-label orange">rfv</mark> 肯定都代表一个数字，只是class不同）：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;qaz&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-12</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;wsx&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-23</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;edc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;rfv&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-12</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>我们直接构建上述字<mark class="hl-label green">注意</mark> 典即可。</p>
<p>这种搜索position-x逆序排列，有个巨大漏：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-8.2.png" alt="雪碧图反爬-8.2"></p>
<blockquote>
<p>错误代码</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">爬虫-雪碧图-1</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> env <span class="hljs-keyword">import</span> Env<br><span class="hljs-keyword">from</span> lxml <span class="hljs-keyword">import</span> etree<br><span class="hljs-keyword">import</span> re<br><br><span class="hljs-comment"># 调用封装的登陆环境</span><br>env = Env()<br>session = env.login()<br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">源码中通过解析style, 返回</span><br><span class="hljs-string">返回值1: &#123; &quot;qaz&quot;: &quot;-12&quot;, &quot;wsx&quot;: &quot;0&quot;, &quot;rfv&quot;: &quot;-12&quot;, ...&#125;</span><br><span class="hljs-string">返回值2: [ &quot;0&quot;, &quot;-12&quot; ]</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_clazzs_num_dict</span>(<span class="hljs-params">style</span>):<br>    <span class="hljs-comment"># res结构如下: [(&#x27;fDn6AFGqT&#x27;, &#x27;-23&#x27;), (&#x27;brq23DUc&#x27;, &#x27;-36&#x27;), ...]</span><br>    class_num_dict = re.findall(<span class="hljs-string">&#x27;.([0-9a-zA-Z]+) &#123; background-position-x:(-?\\d+)px &#125;&#x27;</span>, style)<br>    class_num_dict = <span class="hljs-built_in">dict</span>(class_num_dict)<br><br>    <span class="hljs-comment"># 对num逆序排序</span><br>    <span class="hljs-comment"># 先去重</span><br>    offset_list = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">set</span>(class_num_dict.values()))<br>    <span class="hljs-comment"># 再根据offset数值进行排序</span><br>    offset_list.sort(key=<span class="hljs-keyword">lambda</span> item: <span class="hljs-built_in">int</span>(item), reverse=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-built_in">print</span>(class_num_dict)<br>    <span class="hljs-built_in">print</span>(offset_list)<br><br>    <span class="hljs-keyword">return</span> class_num_dict, offset_list<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">获取每一页数字和</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_page_sum</span>(<span class="hljs-params">page_num</span>):<br>    url = <span class="hljs-string">f&quot;http://www.glidedsky.com/level/web/crawler-sprite-image-1?page=<span class="hljs-subst">&#123;page_num&#125;</span>&quot;</span><br>    response = session.get(url, headers=env.headers)<br>    <span class="hljs-comment"># 获取每一个数字框</span><br>    html = etree.HTML(response.text)<br>    div_list = html.xpath(<span class="hljs-string">&#x27;//div[@class=&quot;card-body&quot;]//div[@class=&quot;col-md-1&quot;]&#x27;</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span>*<span class="hljs-number">100</span>)<br>    <span class="hljs-built_in">print</span>(response.text)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span>*<span class="hljs-number">100</span>)<br><br>    <span class="hljs-comment"># css样式表字符串</span><br>    style = html.xpath(<span class="hljs-string">&#x27;normalize-space(//style/text())&#x27;</span>)<br>    <span class="hljs-comment"># 得到 class -&gt; num 的字典</span><br>    clazz_num_dict, offset_list = get_clazzs_num_dict(style)<br>    <span class="hljs-comment"># 每页和</span><br>    page_total = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> div_col <span class="hljs-keyword">in</span> div_list:<br>        <span class="hljs-comment"># 一个div.col-md-1内有length个子div(即数字是length位数)</span><br>        length = <span class="hljs-built_in">len</span>(div_col)<br>        one = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, length):<br>            <span class="hljs-comment"># 如class=&quot;Fp0PceYg sprite&quot; 应该只要Fp0PceYg</span><br>            clazz = div_col[i].attrib[<span class="hljs-string">&#x27;class&#x27;</span>]<br>            clazz = clazz[:clazz.index(<span class="hljs-string">&#x27; &#x27;</span>)]<br>            <span class="hljs-comment"># clazz_num_dict 中, 键为class, 值为offset</span><br>            offset = clazz_num_dict[clazz]<br>            <span class="hljs-comment"># 百位乘100 十位乘10 个位乘1</span><br>            one += offset_list.index(offset) * <span class="hljs-built_in">pow</span>(<span class="hljs-number">10</span>, length-i-<span class="hljs-number">1</span>)<br><br>        <span class="hljs-comment"># 加这一个数</span><br>        <span class="hljs-built_in">print</span>(one)<br>        page_total += one<br><br>    <span class="hljs-keyword">return</span> page_total<br><br><br><span class="hljs-comment"># 总和</span><br>total = <span class="hljs-number">0</span><br><span class="hljs-comment"># 定义和</span><br><span class="hljs-comment"># for page_num in range(1, 1001):</span><br><span class="hljs-keyword">for</span> page_num <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>):<br>    total += get_page_sum(page_num)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;前 <span class="hljs-subst">&#123;page_num&#125;</span> 页和为 <span class="hljs-subst">&#123;total&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure>



<blockquote>
<p>所以说明：之前的思路全部有问题，参考网上解法后，发现还是得均匀切割图片划分横向10个坐标范围，分别表示[0 ,9]，</p>
<p>这里能取巧就是将 <code>|position-x| * 10 / 整个图片横向宽度</code> 取整即为数字,注意取最接近的整数(如3.2取3, 3.8取4)</p>
</blockquote>
<p>这个算式依旧存在问题,因为不同的单位数字还存在一个不同的宽度！！！！</p>
<p>以上这个方法是默认图片中一串数字划分比较整齐采用的估算形式，实际并不准确。</p>
<blockquote>
<p>下面参考大佬（github搜索&lt;!–swig￼41–&gt;）的像素法，竖线扫描判断黑白，以此划分出每个数字坐标范围。</p>
</blockquote>
<p>个人分析：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-8.3.png" alt="雪碧图反爬-8.3"></p>
<p>将断点形成列表（长度为11，包括开始、结尾），那么每顺序2个列表元素就能形成10个区间，那么真实的数字就和这个列表的索引产生联系了。</p>
<p>重点在于如何扫描分割：遍历横坐标，循环内遍历纵坐标，遍历纵坐标过程出现黑点即表示当前的横坐标就是<code>数字的开始</code>（除0以外，因为 0 总是从 position-x: 0px 开始的）。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-8.4.png" alt="雪碧图反爬-8.4"></p>
<p>如此能得到10个position-x的值，列表追加一个图片宽度即为结果，就合成为总的包含10个区间的判定列表。</p>
<p>之前的划分方式有错，应该在0结束的时候就开始分隔，因为此时0已经不会再出现了。</p>
<p>结合页面分析：0偏移为 <mark class="hl-label orange">-7</mark>  时，</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-8.5.png" alt="雪碧图反爬-8.5"></p>
<p>0偏移为 <mark class="hl-label orange">-8</mark>  时，就已经消失，0都已经消失了，也就不可能算在0的范围内了。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-8.6.png" alt="雪碧图反爬-8.6"></p>
<p>所以应当按下面这种方法划分。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-8.7.png" alt="雪碧图反爬-8.7"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">爬虫-雪碧图-1</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> env <span class="hljs-keyword">import</span> Env<br><span class="hljs-keyword">from</span> lxml <span class="hljs-keyword">import</span> etree<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> io<br><br><span class="hljs-comment"># 调用封装的登陆环境</span><br>env = Env()<br>session = env.login()<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">生成分隔列表</span><br><span class="hljs-string">    如: [-1, 8, 19, 31, 43, 54, 66, 79, 93, 104, 117]</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_split_list</span>(<span class="hljs-params">style</span>):<br>    split = []<br>    <span class="hljs-comment"># 获取图片的尺寸</span><br>    base64_bytes = base64.b64decode(re.search(<span class="hljs-string">&#x27;base64,(.*?)\&quot;&#x27;</span>, style).group(<span class="hljs-number">1</span>))<br>    fio = io.BytesIO(base64_bytes)<br>    img = Image.<span class="hljs-built_in">open</span>(fio)<br>    <span class="hljs-comment"># 获取像素集</span><br>    pixels = img.load()<br>    <span class="hljs-comment"># 前一列上 全白</span><br>    last_x_all_white = <span class="hljs-literal">True</span><br>    <span class="hljs-comment"># x 表示从左到右</span><br>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(img.width):<br>        <span class="hljs-comment"># 当前列全为白色</span><br>        current_x_all_white = <span class="hljs-literal">True</span><br>        <span class="hljs-comment"># y 表示从上到下</span><br>        <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(img.height):<br>            <span class="hljs-comment"># print(f&#x27;&#123;x,y&#125;: &#x27;, pixels[x, y])</span><br>            <span class="hljs-comment"># rgb和等于255*3, 则为白色, 不等则不为白色</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">sum</span>(pixels[x, y][:<span class="hljs-number">3</span>]) != <span class="hljs-number">255</span> * <span class="hljs-number">3</span>:<br>                <span class="hljs-comment"># 当前列存在 非白色</span><br>                current_x_all_white = <span class="hljs-literal">False</span><br>                <span class="hljs-keyword">break</span><br><br>        <span class="hljs-comment"># 一列结束 若current_x_all_white还为True 那么说明当前列全为白色</span><br>        <span class="hljs-keyword">if</span> current_x_all_white:<br>            <span class="hljs-comment"># 当前列全白色, 并且上一列存在黑</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> last_x_all_white:<br>                split.append(x)<br><br>        <span class="hljs-comment"># 进行下一列之前 last_x_all_white就得根据当前列重新赋值</span><br>        last_x_all_white = current_x_all_white<br><br>    <span class="hljs-comment"># 开头插入-1 因为只记录了0的结束 没有记录开始</span><br>    split.insert(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>)<br>    <span class="hljs-comment"># 赋值最后一个为图片宽度</span><br>    split[<span class="hljs-built_in">len</span>(split) - <span class="hljs-number">1</span>] = img.width<br><br>    <span class="hljs-keyword">return</span> split<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">源码中通过解析style, 构建 class -&gt; offset </span><br><span class="hljs-string">返回值结构: &#123; &quot;qaz&quot;: &#x27;-12&#x27;, &quot;wsx&quot;: &#x27;0&#x27;, &quot;rfv&quot;: &#x27;-12&#x27;, ...&#125;</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_clazzs_num_dict</span>(<span class="hljs-params">style</span>):<br>    <span class="hljs-comment"># findall结构如下: [(&#x27;qaz&#x27;, &#x27;-12&#x27;), (&#x27;wsx&#x27;, &#x27;0&#x27;), (&#x27;rfv&#x27;: &#x27;-12&#x27;) ...]</span><br>    <span class="hljs-comment"># 使用dict构建如下字典 &#123; &quot;qaz&quot;: &quot;-12&quot;, &quot;wsx&quot;: &quot;0&quot;, &quot;rfv&quot;: &quot;-12&quot;, ...&#125;</span><br>    class_num_dict = <span class="hljs-built_in">dict</span>(re.findall(<span class="hljs-string">&#x27;.([0-9a-zA-Z]+) &#123; background-position-x:(-?\\d+)px &#125;&#x27;</span>, style))<br>    <span class="hljs-comment"># 将值转为int 并取绝对值</span><br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> class_num_dict:<br>        class_num_dict[_] = <span class="hljs-built_in">abs</span>(<span class="hljs-built_in">int</span>(class_num_dict[_]))<br>    <span class="hljs-keyword">return</span> class_num_dict<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">获取每一页数字和</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_page_sum</span>(<span class="hljs-params">page_num</span>):<br>    url = <span class="hljs-string">f&quot;http://www.glidedsky.com/level/web/crawler-sprite-image-1?page=<span class="hljs-subst">&#123;page_num&#125;</span>&quot;</span><br>    response = session.get(url, headers=env.headers)<br>    <span class="hljs-comment"># 获取每一个数字框</span><br>    html = etree.HTML(response.text)<br>    div_list = html.xpath(<span class="hljs-string">&#x27;//div[@class=&quot;card-body&quot;]//div[@class=&quot;col-md-1&quot;]&#x27;</span>)<br><br>    <span class="hljs-comment"># css样式表字符串</span><br>    style = html.xpath(<span class="hljs-string">&#x27;normalize-space(//style/text())&#x27;</span>)<br>    <span class="hljs-comment"># 得到 class -&gt; offset 的字典</span><br>    class_num_dict = get_clazzs_num_dict(style)<br>    <span class="hljs-comment"># 得到分隔列表</span><br>    split_list = get_split_list(style)<br>    <span class="hljs-comment"># 每页和</span><br>    page_total = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> div_col <span class="hljs-keyword">in</span> div_list:<br>        <span class="hljs-comment"># 一个数包含多少位</span><br>        length = <span class="hljs-built_in">len</span>(div_col)<br>        num = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, length):<br>            <span class="hljs-comment"># 如class=&quot;Fp0PceYg sprite&quot; 应该只要Fp0PceYg</span><br>            clazz = div_col[_].attrib[<span class="hljs-string">&#x27;class&#x27;</span>]<br>            clazz = clazz[:clazz.index(<span class="hljs-string">&#x27; &#x27;</span>)]<br>            <span class="hljs-comment"># clazz_num_dict 中, 键为class, 值为偏移</span><br>            offset = class_num_dict[clazz]<br>            <span class="hljs-comment"># 获得真实数字n</span><br>            <span class="hljs-keyword">for</span> index, split <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(split_list):<br>                <span class="hljs-comment"># 当offset为0 split为-1 这才能判断成功</span><br>                <span class="hljs-keyword">if</span> offset &lt; split:<br>                    n = index - <span class="hljs-number">1</span><br>                    <span class="hljs-keyword">break</span><br>            num += n * <span class="hljs-built_in">pow</span>(<span class="hljs-number">10</span>, length - _ - <span class="hljs-number">1</span>)<br><br>        <span class="hljs-comment"># 加这一个数, 每页有12个数嘛</span><br>        page_total += num<br><br>    <span class="hljs-keyword">return</span> page_total<br><br><br><span class="hljs-comment"># 总和</span><br>total = <span class="hljs-number">0</span><br><span class="hljs-comment"># 定义和</span><br><span class="hljs-keyword">for</span> page_num <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1001</span>):<br>    total += get_page_sum(page_num)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;前 <span class="hljs-subst">&#123;page_num&#125;</span> 页和为: <span class="hljs-subst">&#123;total&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure>



<h1 id="爬虫-验证码-1"><a href="#爬虫-验证码-1" class="headerlink" title="爬虫-验证码-1"></a>爬虫-验证码-1</h1><p>分析：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.1.png" alt="验证码-9.1"></p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.2.png" alt="验证码-9.2"></p>
<p>滑动按钮应该右移的距离得到了，直接操作滑动按钮右移，即可完成该滑动验证。</p>
<p>需要注意，验证框是<code>iframe</code>标签，需要 <mark class="hl-label orange">driver.switch_to.frame(frame_element)</mark>  操作。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">driver.switch_to.frame(iframe_element) <span class="hljs-comment"># 转向到该frame中</span><br><br><span class="hljs-string">&quot;&quot;&quot;操作frame外边的元素需要切换出去&quot;&quot;&quot;</span><br>windows = driver.window_handles<br>driver.switch_to.window(windows[<span class="hljs-number">0</span>])<br></code></pre></td></tr></table></figure>





<p>注意图片还做了干扰处理：容易看出的有四角、上方</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.3.png" alt="验证码-9.3"></p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.4.png" alt="验证码-9.4"></p>
<p>然后就得给个阈值，看一列有多少个不同的像素点以上，才算到了凹陷块。</p>
<p>经过测试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">第 0 列像素点差异为 39<br>第 1 列像素点差异为 40<br>第 2 列像素点差异为 39<br>第 3 列像素点差异为 40<br>第 4 列像素点差异为 39<br>第 5 列像素点差异为 39<br>第 6 列像素点差异为 36<br>第 7 列像素点差异为 26<br>第 8 列像素点差异为 25<br>第 9 列像素点差异为 37<br>.<br>.<br>.<br>第 204 列像素点差异为 23<br>第 205 列像素点差异为 22<br>第 206 列像素点差异为 23<br>第 207 列像素点差异为 51<br>第 208 列像素点差异为 49<br>第 209 列像素点差异为 39<br>第 210 列像素点差异为 41<br>第 211 列像素点差异为 40<br>第 212 列像素点差异为 40<br>第 213 列像素点差异为 38<br>第 214 列像素点差异为 39<br><br>.<br>.<br>.<br>第 399 列像素点差异为 81<br>第 400 列像素点差异为 61<br>第 401 列像素点差异为 16<br>第 402 列像素点差异为 17<br>第 403 列像素点差异为 16<br>第 404 列像素点差异为 17<br>第 405 列像素点差异为 16<br>第 406 列像素点差异为 17<br><br></code></pre></td></tr></table></figure>

<p>说明整个图片都是做了混淆处理的！！！</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.5.png" alt="验证码-9.5"></p>
<p>判断缺口的策略：</p>
<p>最开始是打算到了某一列，像素差异个数剧增，并且在接下来10列中保持像素差异点超过100，那么判断这个剧增列就是凹陷图的开始。</p>
<blockquote>
<p>但是后来发现，不大行！！图片的混淆做的太好了……</p>
</blockquote>
<p>后来采用在rgb三个数离（255，255，255）相差都仅小于10，并且一列中有40（因为有时凹陷图左中部有缺口，没缺口的话达到50个应该没问题）个这样的像素点以上，判断这列为凹陷图的开始。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.6.png" alt="验证码-9.6"></p>
<blockquote>
<p>后来策略又换成了</p>
<p>后来采用在rgb三个数离（255，255，255）相差都大于50时，认定这就是凹陷块开始得位置！！！</p>
</blockquote>
<p>确定selenium获取的webelement对象的坐标属性时，发现怎么都对不上号，所以才有接下来的测试selenium的location（x和y值）：</p>
<p>调试：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.7.png" alt="验证码-9.7"></p>
<p>form坐标为（298，212），但是在没调整下面这个设置之前总是对不上号！！！</p>
<p>注意眼观浏览器多宽的时候，一定要把win10显示设置为100%</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.8.png" alt="验证码-9.8"></p>
<p>调整之后，能对上号了。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.9.png" alt="验证码-9.9"></p>
<p>接下来确保代码中测量的距离都是对的，在以上显示设置设置为100%！！！之后进行测量。</p>
<p>滑块位置：x偏移是36</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.10.png" alt="验证码-9.10"></p>
<p>下面是iframe的范围：（图中白色框是我用snipaste截出的 <code>36*89</code> 的矩形）</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.11.png" alt="验证码-9.11"></p>
<p>下面是图片的范围：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.12.png" alt="验证码-9.12"></p>
<p>由此，我们得出，在这里得出的location，是相对于iframe本身的！！！</p>
<p>还记得之前分析的这个图？</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.13.png" alt="验证码-9.13"></p>
<p>但由于图片还有个透明四周，这个推理要发生变化。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.14.png" alt="验证码-9.14"></p>
<p>滑块相对图片的偏移应该是：x + x2 - x3</p>
<p>x：图片相对iframe的x</p>
<p>x2：滑块图片的透明四周宽度（大概有11.5）</p>
<p>这里x2它原图是136的，现在浏览器中是68的，原图四周宽度为23，按比例计算，浏览器中四周宽度为：68*23-136&#x3D;11.5</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.15.png" alt="验证码-9.15"></p>
<p>x3：大的验证图片相对iframe有个padding（大概有9.6）</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.16.png" alt="验证码-9.16"></p>
<p>所以，我们拿到滑块的location[‘x’]后直接减2即可。</p>
<p>绿线的距离（就是缺口相对于大图片的x位置）：因为获取的链接的图片，分辨率是实际显示的2倍，所以得到绿线之间的距离还得除以2。</p>
<p>selenium存在点问题，个人修正，不然滑动块移动得很慢！！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">C:\Users\L\AppData\Local\Programs\Python\Python37\Lib\site-packages\selenium\webdriver\common\actions<br></code></pre></td></tr></table></figure>

<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.17.png" alt="验证码-9.17"></p>
<p>成功的标志：存在 <code>show-success</code> 的class的div出现。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.18.png" alt="验证码-9.18"></p>
<blockquote>
<p>代码</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">爬虫-验证码-1</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver<br><span class="hljs-keyword">from</span> selenium.webdriver <span class="hljs-keyword">import</span> ActionChains<br><span class="hljs-keyword">from</span> selenium.webdriver.support.wait <span class="hljs-keyword">import</span> WebDriverWait<br><span class="hljs-keyword">from</span> selenium.webdriver.support <span class="hljs-keyword">import</span> expected_conditions <span class="hljs-keyword">as</span> EC<br><span class="hljs-keyword">from</span> selenium.webdriver.common.by <span class="hljs-keyword">import</span> By<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> io<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> random<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SeleniumEnv</span>(<span class="hljs-title class_ inherited__">object</span>):<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.driver_path = <span class="hljs-string">&#x27;D:\\driver\\89.0\\chromedriver.exe&#x27;</span><br>        self.url = <span class="hljs-string">&#x27;http://www.glidedsky.com/level/web/crawler-captcha-1?page=&#x27;</span><br><br>        self.driver = webdriver.Chrome(self.driver_path)<br>        <span class="hljs-comment"># 参数10表示最长等待10秒, 参数0.5表示0.5秒检查一次规定的标签是否存在</span><br>        self.wait = WebDriverWait(self.driver, <span class="hljs-number">2</span>, <span class="hljs-number">0.5</span>)<br><br>    <span class="hljs-comment"># 登陆</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 登陆</span><br>        self.driver.get(<span class="hljs-string">&quot;http://www.glidedsky.com/login&quot;</span>)<br>        <span class="hljs-comment"># 最大化窗口</span><br>        self.driver.maximize_window()<br>        self.driver.find_element_by_id(<span class="hljs-string">&#x27;email&#x27;</span>).send_keys(<span class="hljs-string">&#x27;ls1229344939@163.com&#x27;</span>)<br>        self.driver.find_element_by_id(<span class="hljs-string">&#x27;password&#x27;</span>).send_keys(<span class="hljs-string">&#x27;lovenowhyly0&#x27;</span>)<br>        self.driver.find_element_by_class_name(<span class="hljs-string">&#x27;btn-primary&#x27;</span>).click()<br>        time.sleep(<span class="hljs-number">1</span>)<br><br>    <span class="hljs-comment"># 获取滑动按钮对象</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_slide_button</span>(<span class="hljs-params">self</span>):<br>        time.sleep(<span class="hljs-number">1</span>)<br>        btn = self.driver.find_element_by_id(<span class="hljs-string">&#x27;slideBlock&#x27;</span>)<br>        <span class="hljs-keyword">return</span> btn<br><br>    <span class="hljs-comment"># 获得原图和凹陷图的url元组</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_origin_cover_image</span>(<span class="hljs-params">self</span>):<br>        time.sleep(<span class="hljs-number">1</span>)<br>        slide_bg = self.driver.find_element_by_id(<span class="hljs-string">&#x27;slideBg&#x27;</span>)<br>        <span class="hljs-comment"># 测试(链接总是为空...)</span><br>        <span class="hljs-comment"># print(&#x27;slide_bg: &#x27;, slide_bg)</span><br>        cover_url = slide_bg.get_attribute(<span class="hljs-string">&#x27;src&#x27;</span>)<br>        <span class="hljs-comment"># print(&#x27;property:&#x27;, cover_url)</span><br>        origin_url = cover_url.replace(<span class="hljs-string">&#x27;img_index=1&#x27;</span>, <span class="hljs-string">&#x27;img_index=0&#x27;</span>)<br>        <span class="hljs-comment"># print(&#x27;原来: &#x27;, origin_url)</span><br>        <span class="hljs-comment"># print(&#x27;覆盖: &#x27;, cover_url)</span><br>        <span class="hljs-keyword">return</span> origin_url, cover_url<br><br>    <span class="hljs-comment"># 判断2个像素点 不同返回True</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">point_diff</span>(<span class="hljs-params">self, origin_pixel, cover_pixel, threshold</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">abs</span>(origin_pixel[<span class="hljs-number">0</span>] - cover_pixel[<span class="hljs-number">0</span>]) &gt; threshold \<br>               <span class="hljs-keyword">and</span> <span class="hljs-built_in">abs</span>(origin_pixel[<span class="hljs-number">1</span>] - cover_pixel[<span class="hljs-number">1</span>]) &gt; threshold \<br>               <span class="hljs-keyword">and</span> <span class="hljs-built_in">abs</span>(origin_pixel[<span class="hljs-number">2</span>] - cover_pixel[<span class="hljs-number">2</span>]) &gt; threshold<br><br>    <span class="hljs-comment"># 对比原图和凹陷图, 获取凹陷图相对相对整个图片的x偏移量</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_offset_cover</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 分别是原图和凹陷图的url</span><br>        origin_url, cover_url = self.get_origin_cover_image()<br>        <span class="hljs-comment"># 请求</span><br>        origin_img = Image.<span class="hljs-built_in">open</span>(io.BytesIO(requests.get(origin_url).content))<br>        origin_pixels = origin_img.load()<br>        <span class="hljs-comment"># cover_pixels = Image.open(io.BytesIO(requests.get(cover_url).content)).load()</span><br>        cover_img = Image.<span class="hljs-built_in">open</span>(io.BytesIO(requests.get(cover_url).content))<br>        cover_pixels = cover_img.load()<br><br>        width = cover_img.width<br>        height = cover_img.height<br>        <span class="hljs-comment"># 原图是680*390 浏览器实际显示有340*195左右 最后偏移要除以2 (680/340)</span><br>        <span class="hljs-comment"># 阈值</span><br>        threshold = <span class="hljs-number">50</span><br>        <span class="hljs-comment"># 取巧 因为观察到的结果中 凹陷图在的像素都大于了400像素</span><br>        <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">350</span>, width):<br>            <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, height):<br>                <span class="hljs-comment"># 阈值设置为50吧...  r,g,b值都相差50以上</span><br>                <span class="hljs-keyword">if</span> self.point_diff(origin_pixels[x, y], cover_pixels[x, y], threshold):<br>                    <span class="hljs-comment"># print(f&#x27;原图像素点: &#123;origin_pixels[x, y]&#125;, 凹陷图像素点: &#123;cover_pixels[x, y]&#125;&#x27;)</span><br>                    <span class="hljs-keyword">return</span> x / <span class="hljs-number">2</span><br><br>    <span class="hljs-comment"># 获取滑块相对整个图片的x偏移量</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_offset_slider</span>(<span class="hljs-params">self</span>):<br>        time.sleep(<span class="hljs-number">1</span>)<br>        <span class="hljs-comment"># self.wait.until(EC.presence_of_element_located((By.ID, &#x27;slideBlock&#x27;)))</span><br>        slide_block = self.driver.find_element_by_id(<span class="hljs-string">&#x27;slideBlock&#x27;</span>)<br>        <span class="hljs-comment"># 减2 相关说明看笔记</span><br>        slider_x = <span class="hljs-built_in">int</span>(slide_block.location[<span class="hljs-string">&#x27;x&#x27;</span>]) - <span class="hljs-number">2</span><br>        <span class="hljs-comment"># print(slider_x)</span><br>        <span class="hljs-keyword">return</span> slider_x<br><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        验证码验证过程</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">checkout</span>(<span class="hljs-params">self, page_num</span>):<br>        <span class="hljs-keyword">try</span>:<br>            time.sleep(<span class="hljs-number">1</span>)<br>            self.driver.get(self.url + <span class="hljs-built_in">str</span>(page_num))<br>            <span class="hljs-comment"># 注意！！！ 验证模块在iframe标签中</span><br>            <span class="hljs-comment"># 哪个找不到 就在哪个前面加sleep ＞﹏＜</span><br>            time.sleep(<span class="hljs-number">1</span>)<br>            <span class="hljs-comment"># self.wait.until(EC.presence_of_element_located((By.ID, &#x27;tcaptcha_iframe&#x27;)))</span><br>            iframe = self.driver.find_element_by_id(<span class="hljs-string">&#x27;tcaptcha_iframe&#x27;</span>)<br>            self.driver.switch_to.frame(iframe)<br>            <span class="hljs-comment"># 获得滑动按钮</span><br>            slide_btn = self.get_slide_button()<br>            <span class="hljs-comment"># 获取滑块相对整个图片的x偏移量</span><br>            slider_x = self.get_offset_slider()<br>            <span class="hljs-comment"># 获取凹陷图相对相对整个图片的x偏移量</span><br>            cover_x = self.get_offset_cover()<br>            <span class="hljs-comment"># 计算得到按钮向右按动的距离</span><br>            <span class="hljs-comment"># print(f&#x27;cover_x: &#123;cover_x&#125;, slider_x: &#123;slider_x&#125;&#x27;)</span><br>            move_x = cover_x - slider_x<br>            <span class="hljs-comment"># print(&#x27;move_x:&#x27;, move_x)</span><br>            self.move_to_gap(slide_btn, self.get_track(move_x))<br><br>            <span class="hljs-comment"># 用until等太久了</span><br>            success = self.wait.until(EC.presence_of_element_located((By.CLASS_NAME, <span class="hljs-string">&#x27;show-success&#x27;</span>)))<br><br>            <span class="hljs-comment"># 返回是否成功校验</span><br>            <span class="hljs-keyword">return</span> success <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(e)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-comment"># 计算当前页数字和</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_total</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 切出iframe</span><br>        windows = self.driver.window_handles<br>        self.driver.switch_to.window(windows[<span class="hljs-number">0</span>])<br>        div_list = self.driver.find_elements_by_xpath(<span class="hljs-string">&#x27;//div[@class=&quot;card-body&quot;]//div[@class=&quot;col-md-1&quot;]&#x27;</span>)<br><br>        page_total = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> div <span class="hljs-keyword">in</span> div_list:<br>            page_total += <span class="hljs-built_in">int</span>(div.text)<br><br>        <span class="hljs-keyword">return</span> page_total<br><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">       根据偏移量获取移动轨迹</span><br><span class="hljs-string">       :param distance: 偏移量</span><br><span class="hljs-string">       :return: 移动轨迹</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_track</span>(<span class="hljs-params">self, distance</span>):<br>        <span class="hljs-comment"># 移动轨迹</span><br>        track = []<br>        <span class="hljs-comment"># 当前位移</span><br>        current = <span class="hljs-number">0</span><br>        <span class="hljs-comment"># 减速阈值</span><br>        mid = distance * <span class="hljs-number">4</span> / <span class="hljs-number">5</span><br>        <span class="hljs-comment"># 计算间隔</span><br>        t = <span class="hljs-number">0.3</span><br>        <span class="hljs-comment"># 初速度</span><br>        v = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">while</span> current &lt; distance:<br>            <span class="hljs-keyword">if</span> current &lt; mid:<br>                <span class="hljs-comment"># 加速度为正5</span><br>                a = <span class="hljs-number">5</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-comment"># 加速度为负3</span><br>                a = -<span class="hljs-number">3</span><br>            <span class="hljs-comment"># 当前速度v1 = v0 + at</span><br>            v = v + a * t<br>            <span class="hljs-comment"># 移动距离x = v0t + 1/2 * a * t^2</span><br>            move = v * t + <span class="hljs-number">1</span> / <span class="hljs-number">2</span> * a * t * t<br>            <span class="hljs-comment"># 当前位移</span><br>            current += move<br>            <span class="hljs-keyword">if</span> current &gt; distance:<br>                track.append(distance - current + move)<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-comment"># 加入轨迹</span><br>            track.append(<span class="hljs-built_in">round</span>(move))<br>            <span class="hljs-comment"># t时间后, 现在的速度</span><br>            v = v + a * t<br><br>        <span class="hljs-comment"># print(f&#x27;track: &#123;track&#125;&#x27;)</span><br>        <span class="hljs-keyword">return</span> track<br><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        拖动滑块到缺口处</span><br><span class="hljs-string">        :param slider: 滑块</span><br><span class="hljs-string">        :param track: 轨迹</span><br><span class="hljs-string">        :return:</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">move_to_gap</span>(<span class="hljs-params">self, slider, track</span>):<br>        ActionChains(self.driver).click_and_hold(slider).perform()<br><br>        <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> track:<br>            ActionChains(self.driver).move_by_offset(xoffset=x, yoffset=<span class="hljs-number">0</span>).perform()<br><br>        time.sleep(random.random())<br>        ActionChains(self.driver).release().perform()<br><br><br>env = SeleniumEnv()<br>env.login()<br><br>total = <span class="hljs-number">0</span><br><span class="hljs-comment"># 访问的页数</span><br>page = <span class="hljs-number">967</span><br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    sign = env.checkout(page)<br><br>    <span class="hljs-comment"># 如果验证失败</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> sign:<br>        fail_count = <span class="hljs-number">1</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;第 <span class="hljs-subst">&#123;page&#125;</span> 页失败(1)!!!&#x27;</span>)<br>        <span class="hljs-comment"># 重复操作 直到过验证</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            sign = env.checkout(page)<br>            <span class="hljs-keyword">if</span> sign:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;第 <span class="hljs-subst">&#123;page&#125;</span> 页成功(n)!!!&#x27;</span>)<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;第 <span class="hljs-subst">&#123;page&#125;</span> 页失败(n) 又失败<span class="hljs-subst">&#123;fail_count&#125;</span>次!!!&#x27;</span>)<br>                fail_count += <span class="hljs-number">1</span><br>                <span class="hljs-keyword">if</span> fail_count &gt; <span class="hljs-number">3</span>:<br>                    <span class="hljs-comment"># 重启浏览器</span><br>                    env.driver.quit()<br>                    env = SeleniumEnv()<br>                    env.login()<br>                    fail_count = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;第 <span class="hljs-subst">&#123;page&#125;</span> 页成功(1)!!!&#x27;</span>)<br>    <span class="hljs-comment"># 获取当前页和</span><br>    <span class="hljs-comment"># 等数字加载完毕</span><br>    time.sleep(<span class="hljs-number">1</span>)<br>    total += env.get_total()<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;前<span class="hljs-subst">&#123;page&#125;</span>页和为 <span class="hljs-subst">&#123;total&#125;</span> &#x27;</span>)<br>    page += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">if</span> page == <span class="hljs-number">1001</span>:<br>        env.driver.quit()<br>        <span class="hljs-keyword">break</span><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">中间总有网络原因...有时连页面都打不开 实在加载不出来, 分了多次测, 大概测了10多次吧...</span><br><span class="hljs-string">我手动操作都还能一直出现 &quot;网络恍惚了一下&quot;/&quot;拼图块半路丢失&quot;  ???</span><br><span class="hljs-string"></span><br><span class="hljs-string">[1, 272] =&gt; 948786 </span><br><span class="hljs-string">怎么服务器还能 internal server error(nginx) 啊...</span><br><span class="hljs-string">[273, 378) =&gt; 368900</span><br><span class="hljs-string"></span><br><span class="hljs-string">T^T</span><br><span class="hljs-string">[378, 1000] =&gt; 2177686</span><br><span class="hljs-string"></span><br><span class="hljs-string">3495372</span><br><span class="hljs-string"></span><br><span class="hljs-string">怀疑是腾讯防水墙有一定的访问限制, 建议每过100页等个10分钟再爬</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure>



<p>我靠，页面刷新不出来我能咋办啊？</p>
<p>chrome：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.19.png" alt="验证码-9.19"></p>
<p>刷新出来了等自己手动操作也出现这种：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.20.png" alt="验证码-9.20"></p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-9.21.png" alt="验证码-9.21"></p>
<h1 id="爬虫-JS加密1"><a href="#爬虫-JS加密1" class="headerlink" title="爬虫-JS加密1"></a>爬虫-JS加密1</h1><blockquote>
<p>分析</p>
</blockquote>
<p>源码中的响应皆为空串：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/encry-js-10.1.png" alt="js加密-10.1"></p>
<p>结合页面响应分析：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/encry-js-10.2.png" alt="js加密-10.2"></p>
<p>数据应该就是异步加载的了，接下来就是模拟异步GET请求了。</p>
<p>url：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">http://www.glidedsky.com/api/level/web/crawler-javascript-obfuscation-1/items?page=1&amp;t=1617340189&amp;sign=e7c6b4b333bd07e4753288ca683062e925703341<br></code></pre></td></tr></table></figure>

<p>参数分析：</p>
<p>page是页数</p>
<p>t明显是秒级时间戳</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/encry-js-10.3.png" alt="js加密-10.3"></p>
<p>sign就是加密身份验证串了，在源码及响应信息中search不到，并且每次都会变化，那么推测是<code>本地js生成</code>。</p>
<p>调试<code>sha1.js</code>文件：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/encry-js-10.4.png" alt="js加密-10.4"></p>
<p>下一步过后，会发现sign的值就是这个return语句返回的结果。</p>
<p>可以比较watch窗口中的值，这里只列举了前几个值，可以看到都是和sign相等的，可以说明这个函数就是生成sign的函数，返回值正好有40项！</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript">t.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">hex</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finalize</span>();<br>        <span class="hljs-keyword">var</span> t = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h0</span><br>          , h = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h1</span><br>          , s = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h2</span><br>          , i = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h3</span><br>          , e = <span class="hljs-variable language_">this</span>.<span class="hljs-property">h4</span>;<br>        <span class="hljs-keyword">return</span> r[t &gt;&gt; <span class="hljs-number">28</span> &amp; <span class="hljs-number">15</span>] + r[t &gt;&gt; <span class="hljs-number">24</span> &amp; <span class="hljs-number">15</span>] + r[t &gt;&gt; <span class="hljs-number">20</span> &amp; <span class="hljs-number">15</span>] + r[t &gt;&gt; <span class="hljs-number">16</span> &amp; <span class="hljs-number">15</span>] + r[t &gt;&gt; <span class="hljs-number">12</span> &amp; <span class="hljs-number">15</span>] + r[t &gt;&gt; <span class="hljs-number">8</span> &amp; <span class="hljs-number">15</span>] + r[t &gt;&gt; <span class="hljs-number">4</span> &amp; <span class="hljs-number">15</span>] + r[<span class="hljs-number">15</span> &amp; t] + r[h &gt;&gt; <span class="hljs-number">28</span> &amp; <span class="hljs-number">15</span>] + r[h &gt;&gt; <span class="hljs-number">24</span> &amp; <span class="hljs-number">15</span>] + r[h &gt;&gt; <span class="hljs-number">20</span> &amp; <span class="hljs-number">15</span>] + r[h &gt;&gt; <span class="hljs-number">16</span> &amp; <span class="hljs-number">15</span>] + r[h &gt;&gt; <span class="hljs-number">12</span> &amp; <span class="hljs-number">15</span>] + r[h &gt;&gt; <span class="hljs-number">8</span> &amp; <span class="hljs-number">15</span>] + r[h &gt;&gt; <span class="hljs-number">4</span> &amp; <span class="hljs-number">15</span>] + r[<span class="hljs-number">15</span> &amp; h] + r[s &gt;&gt; <span class="hljs-number">28</span> &amp; <span class="hljs-number">15</span>] + r[s &gt;&gt; <span class="hljs-number">24</span> &amp; <span class="hljs-number">15</span>] + r[s &gt;&gt; <span class="hljs-number">20</span> &amp; <span class="hljs-number">15</span>] + r[s &gt;&gt; <span class="hljs-number">16</span> &amp; <span class="hljs-number">15</span>] + r[s &gt;&gt; <span class="hljs-number">12</span> &amp; <span class="hljs-number">15</span>] + r[s &gt;&gt; <span class="hljs-number">8</span> &amp; <span class="hljs-number">15</span>] + r[s &gt;&gt; <span class="hljs-number">4</span> &amp; <span class="hljs-number">15</span>] + r[<span class="hljs-number">15</span> &amp; s] + r[i &gt;&gt; <span class="hljs-number">28</span> &amp; <span class="hljs-number">15</span>] + r[i &gt;&gt; <span class="hljs-number">24</span> &amp; <span class="hljs-number">15</span>] + r[i &gt;&gt; <span class="hljs-number">20</span> &amp; <span class="hljs-number">15</span>] + r[i &gt;&gt; <span class="hljs-number">16</span> &amp; <span class="hljs-number">15</span>] + r[i &gt;&gt; <span class="hljs-number">12</span> &amp; <span class="hljs-number">15</span>] + r[i &gt;&gt; <span class="hljs-number">8</span> &amp; <span class="hljs-number">15</span>] + r[i &gt;&gt; <span class="hljs-number">4</span> &amp; <span class="hljs-number">15</span>] + r[<span class="hljs-number">15</span> &amp; i] + r[e &gt;&gt; <span class="hljs-number">28</span> &amp; <span class="hljs-number">15</span>] + r[e &gt;&gt; <span class="hljs-number">24</span> &amp; <span class="hljs-number">15</span>] + r[e &gt;&gt; <span class="hljs-number">20</span> &amp; <span class="hljs-number">15</span>] + r[e &gt;&gt; <span class="hljs-number">16</span> &amp; <span class="hljs-number">15</span>] + r[e &gt;&gt; <span class="hljs-number">12</span> &amp; <span class="hljs-number">15</span>] + r[e &gt;&gt; <span class="hljs-number">8</span> &amp; <span class="hljs-number">15</span>] + r[e &gt;&gt; <span class="hljs-number">4</span> &amp; <span class="hljs-number">15</span>] + r[<span class="hljs-number">15</span> &amp; e]<br>    &#125;<br></code></pre></td></tr></table></figure>



<p>刷新，重新调试，看下一步执行什么：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/encry-js-10.5.png" alt="js加密-10.5"></p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/encry-js-10.6.png" alt="js加密-10.6"></p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/encry-js-10.7.png" alt="js加密-10.7"></p>
<p>接下来就是如何的到参数<code>t</code>和参数<code>sign</code>了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> p = $(<span class="hljs-string">&#x27;main .container&#x27;</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;p&#x27;</span>);<br><span class="hljs-keyword">let</span> t = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(($(<span class="hljs-string">&#x27;main .container&#x27;</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;t&#x27;</span>) - <span class="hljs-number">99</span>) / <span class="hljs-number">99</span>);<br><span class="hljs-keyword">let</span> sign = <span class="hljs-title function_">sha1</span>(<span class="hljs-string">&#x27;Xr0Z-javascript-obfuscation-1&#x27;</span> + t);<br>$.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/api/level/web/crawler-javascript-obfuscation-1/items?page=&#x27;</span> + p + <span class="hljs-string">&#x27;&amp;t=&#x27;</span> + t + <span class="hljs-string">&#x27;&amp;sign=&#x27;</span> + sign, <span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) &#123;<br>    <span class="hljs-keyword">const</span> list = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data).<span class="hljs-property">items</span>;<br>    $(<span class="hljs-string">&#x27;.col-md-1&#x27;</span>).<span class="hljs-title function_">each</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">index</span>) &#123;<br>        <span class="hljs-keyword">if</span> (list &amp;&amp; index &lt; list.<span class="hljs-property">length</span>) &#123;<br>            $(<span class="hljs-string">&#x27;.col-md-1&#x27;</span>).<span class="hljs-title function_">eq</span>(index).<span class="hljs-title function_">text</span>(list[index])<br>        &#125;<br>    &#125;)<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>t就是当前的秒级时间戳</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">time.time()<br></code></pre></td></tr></table></figure>

<p>sign得调用sha1的函数：参数是<mark class="hl-label +">Xr0Z-javascript-obfuscation-1</mark> ，调用方法是：将sha1.js下载下来，采用js2py，用python动态执行js代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    js加密-1</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> env <span class="hljs-keyword">import</span> Env<br><span class="hljs-keyword">import</span> js2py<br><span class="hljs-keyword">import</span> math<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> json<br><br>env = Env()<br>session = env.login()<br><br><span class="hljs-comment"># 生成js执行环境</span><br>context = js2py.EvalJs()<br><span class="hljs-comment"># python读取js</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;js-obfuscation-1-test/js/sha1.js&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    context.execute(f.read())<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    获得参数t和sign</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_t_and_sign</span>():<br>    <span class="hljs-comment"># 需要提前定义的参数</span><br>    context.t = math.floor(time.time())<br>    <span class="hljs-comment"># 需执行js代码</span><br>    js = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">        var sign = sha1(&#x27;Xr0Z-javascript-obfuscation-1&#x27; + t);</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    <span class="hljs-comment"># 执行js代码</span><br>    context.execute(js)<br>    <span class="hljs-keyword">return</span> context.t, context.sign<br><br><br><span class="hljs-comment"># 定义 和</span><br>total = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> page_num <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1001</span>):<br><br>    t, sign = get_t_and_sign()<br><br>    url = <span class="hljs-string">f&#x27;http://www.glidedsky.com/api/level/web/crawler-javascript-obfuscation-1/items?page=<span class="hljs-subst">&#123;page_num&#125;</span>&amp;t=<span class="hljs-subst">&#123;t&#125;</span>&amp;sign=<span class="hljs-subst">&#123;sign&#125;</span>&#x27;</span><br><br>    response = session.get(url, headers=env.headers)<br><br>    <span class="hljs-comment"># print(json.loads(response.text))</span><br>    nums = json.loads(response.text)[<span class="hljs-string">&#x27;items&#x27;</span>]<br>    total += <span class="hljs-built_in">sum</span>(nums)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;前 <span class="hljs-subst">&#123;page_num&#125;</span> 页数字和为: <span class="hljs-subst">&#123;total&#125;</span>&quot;</span>)<br><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;结果是: <span class="hljs-subst">&#123;total&#125;</span>&quot;</span>)<br><span class="hljs-comment"># 这个运行着就很爽了吖 (•ω•`)  舒服</span><br></code></pre></td></tr></table></figure>





<h1 id="爬虫-验证码-2"><a href="#爬虫-验证码-2" class="headerlink" title="爬虫-验证码-2"></a>爬虫-验证码-2</h1><p>页面访问好像没有内容了：<a target="_blank" rel="noopener" href="http://www.glidedsky.com/level/web/crawler-captcha-2">http://www.glidedsky.com/level/web/crawler-captcha-2</a></p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/veri-11.1.png" alt="验证码-11.1"></p>
<p>只不过就算做，估计我也没法，猜测都是图形判断或者汉字点击了。</p>
<h1 id="雪碧图反爬-2"><a href="#雪碧图反爬-2" class="headerlink" title="雪碧图反爬-2"></a>雪碧图反爬-2</h1><p>试了下百度识图（每天能免费用很多次），发现依然会有识别出错的情况！！！！</p>
<p>找了个类似的代码，自己修改了部分，能实现训练并识别mnist手写数字：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    tensorflow2.0实现手写汉字实现: http://blog.itpub.net/69978904/viewspace-2733646/</span><br><span class="hljs-string">    保存模型: https://www.cnblogs.com/piaodoo/p/14124831.html</span><br><span class="hljs-string">    测试tensorflow2实现mnist手写汉字识别</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-comment"># 一定要放在 import tensorflow 之前才有效 = =</span><br>os.environ[<span class="hljs-string">&#x27;TF_CPP_MIN_LOG_LEVEL&#x27;</span>] = <span class="hljs-string">&#x27;2&#x27;</span><br><br><span class="hljs-keyword">from</span> tensorflow <span class="hljs-keyword">import</span> keras<br><span class="hljs-keyword">from</span> tensorflow.keras.layers <span class="hljs-keyword">import</span> Flatten, Dense<br><span class="hljs-keyword">from</span> tensorflow.keras.datasets <span class="hljs-keyword">import</span> mnist<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br><span class="hljs-comment"># 加载数据集</span><br>(train_images, train_labels), (test_images, test_labels) = mnist.load_data()<br><br><span class="hljs-comment"># 图片每个像素的数值都是在[0, 255]之间，所以归一化要除以255，数据要是浮点数，所以要添加一个小数点</span><br>train_images, test_images = train_images / <span class="hljs-number">255.0</span>, test_images / <span class="hljs-number">255.0</span><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    重新创建一个model</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new_model</span>():<br>    <span class="hljs-comment"># 定义模型</span><br>    <span class="hljs-comment"># 搭建一个顺序模型，第一层先将数据展平，原始图片是28x28的灰度图，所以输入尺寸是（28，28），第二层节点数可以自己选择一个合适值，这里用128个节点，激活函数用relu</span><br>    <span class="hljs-comment">#   第三层有多少个种类就写多少，[0, 9]一共有10个数字,所以必须写10，激活函数用softmax</span><br>    model = keras.Sequential([<br>        Flatten(input_shape=(<span class="hljs-number">28</span>, <span class="hljs-number">28</span>)),<br>        Dense(<span class="hljs-number">128</span>, activation=<span class="hljs-string">&#x27;relu&#x27;</span>),<br>        Dense(<span class="hljs-number">10</span>, activation=<span class="hljs-string">&#x27;softmax&#x27;</span>)<br>    ])<br><br>    <span class="hljs-comment"># 指定优化器、损失函数、评价指标</span><br>    model.<span class="hljs-built_in">compile</span>(optimizer=<span class="hljs-string">&#x27;adam&#x27;</span>,<br>                  loss=<span class="hljs-string">&#x27;sparse_categorical_crossentropy&#x27;</span>,<br>                  metrics=[<span class="hljs-string">&#x27;acc&#x27;</span>])<br><br>    <span class="hljs-keyword">return</span> model<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    已存在的model, 加载权重和偏置(方法一: 保存模型的权重和偏置)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_weights_bias</span>(<span class="hljs-params">model</span>):<br>    <span class="hljs-keyword">if</span> os.path.exists(<span class="hljs-string">&#x27;./tensorflow2_mnist_model/weights_bias_model/checkpoint&#x27;</span>):<br>        model.load_weights(<span class="hljs-string">&#x27;./tensorflow2_mnist_model/weights_bias_model/my_model&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;第一次保存权重和偏置吧? 当前模型文件不存在呐! &#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    保存model的权重和偏置</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">save_weight_bias</span>(<span class="hljs-params">model</span>):<br>    model.save_weights(<span class="hljs-string">&#x27;./tensorflow2_mnist_model/weights_bias_model/my_model&#x27;</span>)<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    训练模型</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_model</span>(<span class="hljs-params">model</span>):<br>    <span class="hljs-comment"># 训练模型</span><br>    model.fit(train_images, train_labels, epochs=<span class="hljs-number">1</span>)<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    保存整个模型(方法二: 直接保存整个模型)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">save_all_model</span>(<span class="hljs-params">model</span>):<br>    model.save(<span class="hljs-string">&#x27;./tensorflow2_mnist_model/all_model/mnist_weights.h5&#x27;</span>)<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    加载整个模型</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_all_model</span>():<br>    <span class="hljs-keyword">if</span> os.path.exists(<span class="hljs-string">&#x27;./tensorflow2_mnist_model/all_model/mnist_weights.h5&#x27;</span>):<br>        <span class="hljs-keyword">return</span> keras.models.load_model(<span class="hljs-string">&#x27;./tensorflow2_mnist_model/all_model/mnist_weights.h5&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;第一次保存整个模型吧? 当前模型文件不存在呐! &#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><br>model = new_model()<br><span class="hljs-comment"># 方法一: 开始</span><br><span class="hljs-comment"># load_weights_bias(model)</span><br><span class="hljs-comment"># train_model(model)</span><br><span class="hljs-comment"># save_weight_bias(model)</span><br><span class="hljs-comment"># 方法一: 结束</span><br><br><span class="hljs-comment"># 方法二: 开始</span><br>reload_model = load_all_model()<br><span class="hljs-keyword">if</span> reload_model <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>    model = reload_model<br><br>train_model(model)<br>save_all_model(model)<br><span class="hljs-comment"># 方法二: 结束</span><br><br><br><span class="hljs-comment"># 用测试集验证模型效果</span><br>test_loss, test_acc = model.evaluate(test_images, test_labels, verbose=<span class="hljs-number">2</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Test acc:&#x27;</span>, test_acc)<br><br><span class="hljs-comment"># 将图片输入模型，返回预测结果 (将测试集中的第一张图片输入模型)</span><br>predictions = model.predict(test_images)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;predictions: &#x27;</span>, predictions)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;预测值:&#x27;</span>, np.argmax(predictions[<span class="hljs-number">0</span>]))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;真实值:&#x27;</span>, test_labels[<span class="hljs-number">0</span>])<br></code></pre></td></tr></table></figure>



<blockquote>
<p>先仿照mnist数据集，将glidedsky上的雪碧图分割成每个小的数字，作为训练集图片，之后再读取图片，构成mnist数据集的数据结构，如此达到最终能识别的目的。</p>
</blockquote>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>训练数据：</p>
<p>在线获取二维雪碧图，用ps切割大的二维雪碧图成小数字图(<a target="_blank" rel="noopener" href="https://jingyan.baidu.com/article/9989c746fe0ffef649ecfe5d.html)%EF%BC%8C%E5%B9%B6%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9%E4%B8%BA18*18%EF%BC%88**%E7%99%BE%E5%BA%A6**%EF%BC%9Ahttps://jingyan.baidu.com/article/9f7e7ec0ecf9676f2815540a.html%EF%BC%8C%E5%B9%B6%E4%B8%94%E8%A6%81%E6%B1%82%E4%B8%BA%E6%96%87%E4%BB%B6%E5%90%8D**%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%AD%97%E6%AF%8D%E6%98%AF%E6%95%B0%E5%AD%97**%E5%8D%B3%E5%8F%AF%EF%BC%8C%E5%A6%82&#39;1.12312z.jpg&#39;%E3%80%81&#39;3.(1)jpg&#39;">https://jingyan.baidu.com/article/9989c746fe0ffef649ecfe5d.html)，并批量修改为18*18（**百度**：https://jingyan.baidu.com/article/9f7e7ec0ecf9676f2815540a.html，并且要求为文件名**第一个字母是数字**即可，如&#39;1.12312z.jpg&#39;、&#39;3.(1)jpg&#39;</a></p>
<p>只不过横向均匀切割还好，但是纵向不行，会打乱数据的完整性，所以最好用代码以像素为基准判断切割好，再用ps统一处理为18*18的训练集（这一步也能用代码完成，所以建议直接用代码下载图片数据集，手动更改文件名作为labels）。</p>
<p>现在只需，将所有18*18图片数据转化为类似mnist的数据结构进行返回：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-12.1.png" alt="雪碧图反爬-12.1"></p>
<p>images和labels数据分别是三维和一维Tensor。</p>
<p>然后就能用最上方的训练代码进行训练了。</p>
<p>后续再多弄点数据集。</p>
<h2 id="代码实现切割出小图"><a href="#代码实现切割出小图" class="headerlink" title="代码实现切割出小图"></a>代码实现切割出小图</h2><p>横向切割，结果是每一行，没一行内再按照数字最小宽度切割，切出来的图片将分辨率调为18*18就得到了训练图。</p>
<p>批量重命名：左键加上 ctrl ，多选，选好了再右键重命名：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-12.2.png" alt="雪碧图反爬-12.2"></p>
<p>右键重命名，输入“1”，下图即为结果（很方便啊）：</p>
<p>用以下代码多生成写训练集，并批量重命名，有耐心一些。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    下载二维雪碧图并实现分割</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> env <span class="hljs-keyword">import</span> Env<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> io<br><br><span class="hljs-comment"># 调用封装的登陆环境</span><br>env = Env()<br>session = env.login()<br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    获取二维雪碧图</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_sprite</span>(<span class="hljs-params">url</span>):<br>    <span class="hljs-comment"># 请求源码</span><br>    response = session.get(url, headers=env.headers)<br><br>    <span class="hljs-comment"># 正则解析base64</span><br>    base64_bytes = base64.b64decode(re.search(<span class="hljs-string">&#x27;base64,(.*?)\&quot;&#x27;</span>, response.text).group(<span class="hljs-number">1</span>))<br><br>    <span class="hljs-comment"># 可以不用写文件, 直接转为Image</span><br>    <span class="hljs-comment"># with open(&#x27;./sprite_img/sprite.png&#x27;, &#x27;wb&#x27;) as f:</span><br>    <span class="hljs-comment">#     f.write(base64_bytes)</span><br><br>    <span class="hljs-keyword">return</span> Image.<span class="hljs-built_in">open</span>(io.BytesIO(base64_bytes))<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    针对每一行的图片进行按列切割, 返回数字的最小宽限集合 如 [(1, 3), (5, 8), ...], 那么横向x 属于 [1, 3] 就是数字0的范围, 一起类推</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_gray_interval</span>(<span class="hljs-params">row_image</span>):<br>    interval_list = []<br><br>    <span class="hljs-comment"># 前一列纯白 为真</span><br>    last_col_all_white = <span class="hljs-literal">True</span><br>    <span class="hljs-comment"># 数字开始x 和 数字结束x (2个变量不能被重复赋值0, 所以放到循环外部)</span><br>    num_start_x = <span class="hljs-number">0</span><br>    num_end_x = <span class="hljs-number">0</span><br><br>    <span class="hljs-comment"># 遍历每一列, 每一行</span><br>    pixels = row_image.load()<br>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(row_image.width):<br>        <span class="hljs-comment"># 当前列纯白为真</span><br>        cur_col_all_white = <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(row_image.height):<br>            <span class="hljs-comment"># 因为是灰度图片 只以 r 值代表颜色即可</span><br>            <span class="hljs-keyword">if</span> pixels[x, y][<span class="hljs-number">0</span>] != <span class="hljs-number">255</span>:<br>                cur_col_all_white = <span class="hljs-literal">False</span><br><br>        <span class="hljs-comment"># 一列迭代结束后</span><br>        <span class="hljs-comment"># 如果 前一列为全白 and 当前列存在灰</span><br>        <span class="hljs-keyword">if</span> last_col_all_white <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> cur_col_all_white:<br>            num_start_x = x<br>        <span class="hljs-comment"># 如果 前一列存在灰 and 当前列全白</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> last_col_all_white <span class="hljs-keyword">and</span> cur_col_all_white:<br>            num_end_x = x<br>            <span class="hljs-comment"># 添加分段信息</span><br>            interval_list.append((num_start_x, num_end_x))<br><br>        <span class="hljs-comment"># 下一列开始前, 重置 last_col_all_white</span><br>        last_col_all_white = cur_col_all_white<br><br>    <span class="hljs-keyword">return</span> interval_list<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    切割为合理大小, 保存到train_img文件夹下, 作为训练集</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">slice_image</span>(<span class="hljs-params">image</span>):<br>    <span class="hljs-comment"># 每一块的高</span><br>    piece_height = image.height / <span class="hljs-number">10</span><br>    <span class="hljs-comment"># 横向能平均切割, 纵向不能, 用ps横纵平均都是10份试一下就知道了</span><br>    <span class="hljs-comment"># 先纵向平均切割10份 0~9</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>        y = i * piece_height<br>        row_image = image.crop((<span class="hljs-number">0</span>, y, image.width, y + piece_height))<br>        <span class="hljs-comment"># 再对每一行的图片进行按列切割</span><br>        interval_list = get_gray_interval(row_image)<br>        <span class="hljs-comment"># 遍历分隔 批量分割 保存数字图片</span><br>        <span class="hljs-keyword">for</span> interval <span class="hljs-keyword">in</span> interval_list:<br>            num_image = row_image.crop((interval[<span class="hljs-number">0</span>], <span class="hljs-number">0</span>, interval[<span class="hljs-number">1</span>], row_image.height))<br>            <span class="hljs-comment"># 重置像素为 18*18 NEAREST: 低质量  BILINEAR: 双线性: BICUBIC: 三次样条插值  ANTIALIAS: 高质量  感觉中间两个效果好一些</span><br>            num_image = num_image.resize((<span class="hljs-number">18</span>, <span class="hljs-number">18</span>), Image.ANTIALIAS)<br>            <span class="hljs-comment"># 暂时随机取名 之后再手动调整为真实数字命名文件</span><br>            num_image.save(<span class="hljs-string">f&#x27;./train_img/<span class="hljs-subst">&#123;random.randint(<span class="hljs-number">11</span>, <span class="hljs-number">1000</span>)&#125;</span>.png&#x27;</span>)<br><br><br>url = <span class="hljs-string">&#x27;http://www.glidedsky.com/level/web/crawler-sprite-image-2?page=1&#x27;</span><br>image = get_sprite(url)<br>slice_image(image)<br></code></pre></td></tr></table></figure>



<p>暂时弄这么多训练集：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-12.3.png" alt="雪碧图反爬-12.3"></p>
<p>再弄这么多测试集：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-12.4.png" alt="雪碧图反爬-12.4"></p>
<h2 id="开始训练"><a href="#开始训练" class="headerlink" title="开始训练"></a>开始训练</h2><p>读取进去的文件名列表，一定记得shuffle一下。</p>
<p>多训练些数据集，如果对测试结果不满意再重新<code>添加些训练集</code>即可。</p>
<p>&#x3D; &#x3D;，有些数字形状也太离谱了吧</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-12.5.png" alt="雪碧图反爬-12.5"></p>
<h2 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h2><p>把base64串和预测结果记录，比较，将<code>不同的数字</code>保存为训练集，再次训练。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-12.6.png" alt="雪碧图反爬-12.6"></p>
<p>把感觉判断不好的数字也一并加入训练集。</p>
<p>1、2、7、4、6、3是高频错点，都全部加入训练集。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-12.7.png" alt="雪碧图反爬-12.7"></p>
<p>反复重复以上对比操作、添加数据集重新训练操作。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-12.8.png" alt="雪碧图反爬-12.8"></p>
<p>这。。，训练集太少了吧？ &#x3D; &#x3D;</p>
<p>再加点：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-12.9.png" alt="雪碧图反爬-12.9"></p>
<p>按这样每行10个区分起来会快速些。</p>
<p>接下来就是不断训练的过程了。</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-12.10.png" alt="雪碧图反爬-12.10"></p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-12.11.png" alt="雪碧图反爬-12.11"></p>
<p>这个 <code>6</code> 就离谱</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-12.12.png" alt="雪碧图反爬-12.12"></p>
<blockquote>
<p>之后才意识到，直接获取第一页数据，因为数字固定，能直接获得真实数字和 <code>small_image</code> 的对应关系。</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/TurboWay/p/13678074.html">https://www.cnblogs.com/TurboWay/p/13678074.html</a></p>
</blockquote>
<p>训练数据：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-12.13.png" alt="雪碧图反爬-12.13"></p>
<p>测试数据：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-12.14.png" alt="雪碧图反爬-12.14"></p>
<p>我靠，resize需要重新赋值，没重新赋值就保存了！全是每resize之前的图片，都得重新下载</p>
<p>新数据：</p>
<p><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/glidedsky/sprite-non-12.15.png" alt="雪碧图反爬-12.15"></p>
<p>重新训练。</p>
<p>然后每页数据的和，请求次数在3次及其以上，并且有个数频率大于等于3&#x2F;4，才算请求成功，否则重新请求当前页数据。</p>
<blockquote>
<p>说明：后续添加训练数据到达42w，应该在10w都够了，我还以为训练出错，多弄了些数据</p>
<p>还有，即使accuracy达到0.98&#x2F;0.97（测试集有10w），实际爬取时出错概率依旧特别高，一定要一个页面多请求几组，取高频出现的那个判定数据！！！</p>
</blockquote>
<blockquote>
<p>代码</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">爬虫-雪碧图-2</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> os<br>os.environ[<span class="hljs-string">&#x27;TF_CPP_MIN_LOG_LEVEL&#x27;</span>] = <span class="hljs-string">&#x27;2&#x27;</span><br><br><span class="hljs-keyword">from</span> env <span class="hljs-keyword">import</span> Env<br><span class="hljs-keyword">from</span> lxml <span class="hljs-keyword">import</span> etree<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> io<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> tensorflow <span class="hljs-keyword">import</span> keras<br><span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf<br><br><span class="hljs-comment"># 调用封装的登陆环境</span><br>env = Env()<br>session = env.login()<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    获取二维雪碧图(同 2.sprite2_base64img_download.py)</span><br><span class="hljs-string">    context: 网页源码</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_sprite</span>(<span class="hljs-params">context</span>):<br>    <span class="hljs-comment"># 正则解析base64</span><br>    base64_bytes = base64.b64decode(re.search(<span class="hljs-string">&#x27;base64,(.*?)\&quot;&#x27;</span>, context).group(<span class="hljs-number">1</span>))<br><br>    <span class="hljs-comment"># 可以不用写文件, 直接转为Image</span><br>    <span class="hljs-comment"># with open(&#x27;./sprite_img/sprite.png&#x27;, &#x27;wb&#x27;) as f:</span><br>    <span class="hljs-comment">#     f.write(base64_bytes)</span><br><br>    <span class="hljs-keyword">return</span> Image.<span class="hljs-built_in">open</span>(io.BytesIO(base64_bytes))<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    针对每一行的图片进行按列切割, 返回数字的最小宽限集合 如 [(1, 3), (5, 8), ...], 那么横向x 属于 [1, 3] 就是数字0的范围, 一起类推</span><br><span class="hljs-string">    (同 2.sprite2_base64img_download.py)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_gray_interval</span>(<span class="hljs-params">row_image</span>):<br>    interval_list = []<br><br>    <span class="hljs-comment"># 前一列纯白 为真</span><br>    last_col_all_white = <span class="hljs-literal">True</span><br>    <span class="hljs-comment"># 数字开始x 和 数字结束x (2个变量不能被重复赋值0, 所以放到循环外部)</span><br>    num_start_x = <span class="hljs-number">0</span><br>    num_end_x = <span class="hljs-number">0</span><br><br>    <span class="hljs-comment"># 遍历每一列, 每一行</span><br>    pixels = row_image.load()<br>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(row_image.width):<br>        <span class="hljs-comment"># 当前列纯白为真</span><br>        cur_col_all_white = <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(row_image.height):<br>            <span class="hljs-comment"># 因为是灰度图片 只以 r 值代表颜色即可</span><br>            <span class="hljs-keyword">if</span> pixels[x, y][<span class="hljs-number">0</span>] != <span class="hljs-number">255</span>:<br>                cur_col_all_white = <span class="hljs-literal">False</span><br><br>        <span class="hljs-comment"># 一列迭代结束后</span><br>        <span class="hljs-comment"># 如果 前一列为全白 and 当前列存在灰</span><br>        <span class="hljs-keyword">if</span> last_col_all_white <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> cur_col_all_white:<br>            num_start_x = x<br>        <span class="hljs-comment"># 如果 前一列存在灰 and 当前列全白</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> last_col_all_white <span class="hljs-keyword">and</span> cur_col_all_white:<br>            num_end_x = x<br>            <span class="hljs-comment"># 添加分段信息</span><br>            interval_list.append((num_start_x, num_end_x))<br><br>        <span class="hljs-comment"># 下一列开始前, 重置 last_col_all_white</span><br>        last_col_all_white = cur_col_all_white<br><br>    <span class="hljs-keyword">return</span> interval_list<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    将图片列表转为类似mnist数据结构的数据, 方便模型进行预测</span><br><span class="hljs-string">    return: [100*18*18] 三维矩阵Tensor</span><br><span class="hljs-string">        基本同 3.sprite2_train_test.py 中的 def get_train_data_like_mnist(train_img_path)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_images_like_mnist_data</span>(<span class="hljs-params">small_images</span>):<br>    <span class="hljs-comment"># 准备三维矩阵</span><br>    images = np.zeros([<span class="hljs-built_in">len</span>(small_images), <span class="hljs-number">18</span>, <span class="hljs-number">18</span>])<br><br>    <span class="hljs-comment"># 遍历每个像素点</span><br>    <span class="hljs-keyword">for</span> index, small_image <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(small_images):<br>        <span class="hljs-comment"># 遍历每个图片的所有像素点</span><br>        width = <span class="hljs-number">18</span><br>        height = <span class="hljs-number">18</span><br>        <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, width):<br>            <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, height):<br>                <span class="hljs-comment"># 单通道取 r值 即可  构建[b, 18, 20]  保证灰度值在 0~1</span><br>                images[index][x][y] = small_image.getpixel((x, y))[<span class="hljs-number">0</span>] / <span class="hljs-number">255.0</span><br><br>    <span class="hljs-comment"># 返回训练数据时, 需要将数据封装为Tensor</span><br>    <span class="hljs-keyword">return</span> tf.convert_to_tensor(images, dtype=tf.float32)<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    预测数字</span><br><span class="hljs-string">    return: 返回数字列表(str形式, 后期方便拼接)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">predict</span>(<span class="hljs-params">small_images, model</span>):<br>    <span class="hljs-comment"># num表示每一页数据 就是12个</span><br>    num_list = []<br><br>    images_data = parse_images_like_mnist_data(small_images)<br>    <span class="hljs-comment"># 进行预测 predictions 是预测的概率值</span><br>    predictions = model.predict(images_data)<br><br>    <span class="hljs-comment"># 预测值填充进 num_list</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(small_images)):<br>        <span class="hljs-comment"># 将int64转为int</span><br>        num_list.append(np.argmax(predictions[i]))<br><br>    <span class="hljs-keyword">return</span> num_list<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    根据每个单数字div的偏移和宽高从雪碧图中切割出小图, 利用模型识别数字</span><br><span class="hljs-string">    image: 二位雪碧图</span><br><span class="hljs-string">    context: 网页源码</span><br><span class="hljs-string">    return: (切割好的 single_bit_image集合, 一页共12个数每个数有几位数字)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">slice_image</span>(<span class="hljs-params">image, context</span>):<br>    <span class="hljs-comment"># 每一位数字的集合</span><br>    single_bit_images = []<br>    <span class="hljs-comment"># 记录总共12个数字 每个数字各有多少位</span><br>    count_bit = []<br><br>    <span class="hljs-comment"># 获取装有数字的div</span><br>    html = etree.HTML(context)<br>    num_divs = html.xpath(<span class="hljs-string">&#x27;//div[@class=&quot;col-md-1&quot;]&#x27;</span>)<br>    <span class="hljs-comment"># 获取css</span><br>    style = html.xpath(<span class="hljs-string">&#x27;//style/text()&#x27;</span>)[<span class="hljs-number">0</span>]<br><br>    <span class="hljs-comment"># 遍历div(一整个数字)</span><br>    <span class="hljs-keyword">for</span> num_div <span class="hljs-keyword">in</span> num_divs:<br>        <span class="hljs-comment"># 记录这个数字有多少位</span><br>        count = <span class="hljs-number">0</span><br>        <span class="hljs-comment"># 遍历每一位数字的每一位</span><br>        <span class="hljs-keyword">for</span> single_bit_div <span class="hljs-keyword">in</span> num_div:<br>            <span class="hljs-comment"># 获取样式</span><br><br>            clazz = single_bit_div.attrib[<span class="hljs-string">&#x27;class&#x27;</span>]<br>            clazz = clazz[:clazz.index(<span class="hljs-string">&#x27; &#x27;</span>)]<br>            <span class="hljs-comment"># 从style查询 offset-x offset-y width height</span><br>            offset_x = <span class="hljs-built_in">abs</span>(<span class="hljs-built_in">int</span>(re.search(clazz + <span class="hljs-string">&#x27; \\&#123; background-position-x:(-?\\d+)px&#x27;</span>, style).group(<span class="hljs-number">1</span>)))<br>            offset_y = <span class="hljs-built_in">abs</span>(<span class="hljs-built_in">int</span>(re.search(clazz + <span class="hljs-string">&#x27; \\&#123; background-position-y:(-?\\d+)px&#x27;</span>, style).group(<span class="hljs-number">1</span>)))<br>            width = <span class="hljs-built_in">abs</span>(<span class="hljs-built_in">int</span>(re.search(clazz + <span class="hljs-string">&#x27; \\&#123; width:(\\d+)px&#x27;</span>, style).group(<span class="hljs-number">1</span>)))<br>            height = <span class="hljs-built_in">abs</span>(<span class="hljs-built_in">int</span>(re.search(clazz + <span class="hljs-string">&#x27; \\&#123; height:(\\d+)px&#x27;</span>, style).group(<span class="hljs-number">1</span>)))<br><br>            <span class="hljs-comment"># 切割 雪碧图中这个偏移和宽高对应的图片 就是当前数字的图</span><br>            single_bit_image = image.crop((offset_x, offset_y, offset_x + width, offset_y + height))<br><br>            <span class="hljs-comment"># resize</span><br>            single_bit_image = single_bit_image.resize((<span class="hljs-number">18</span>, <span class="hljs-number">18</span>), Image.ANTIALIAS)<br><br>            <span class="hljs-comment"># 加入单位数字</span><br>            single_bit_images.append(single_bit_image)<br>            count += <span class="hljs-number">1</span><br><br>        <span class="hljs-comment"># 记录下这个数字的位数</span><br>        count_bit.append(count)<br><br>    <span class="hljs-keyword">return</span> single_bit_images, count_bit<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    根据每一个小数字 和 每个大数字占的位数 的到大数字集合</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mix_num</span>(<span class="hljs-params">single_num_list, count_bit</span>):<br>    index = <span class="hljs-number">0</span><br>    <span class="hljs-comment"># 结果</span><br>    num_list = []<br><br>    <span class="hljs-keyword">for</span> bit <span class="hljs-keyword">in</span> count_bit:<br>        num = <span class="hljs-number">0</span><br>        <span class="hljs-comment"># 按照位数 顺序拼接每一位 循环次数是bit次</span><br>        <span class="hljs-keyword">while</span> bit:<br>            num += single_num_list[index] * (<span class="hljs-number">10</span> ** (bit - <span class="hljs-number">1</span>))<br>            index += <span class="hljs-number">1</span><br>            bit -= <span class="hljs-number">1</span><br><br>        <span class="hljs-comment"># 填入</span><br>        num_list.append(num)<br><br>    <span class="hljs-keyword">return</span> num_list<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    请求返回当前页数字集合</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_num_list</span>(<span class="hljs-params">page_num, model</span>):<br>    url = <span class="hljs-string">f&#x27;http://www.glidedsky.com/level/web/crawler-sprite-image-2?page=<span class="hljs-subst">&#123;page_num&#125;</span>&#x27;</span><br><br>    response = session.get(url, headers=env.headers)<br><br>    <span class="hljs-comment"># 一张 2维雪碧图</span><br>    sprite_image = get_sprite(response.text)<br>    <span class="hljs-comment"># 分割成的 18*18 小图</span><br>    single_bit_images, count_bit = slice_image(sprite_image, response.text)<br><br>    <span class="hljs-comment"># 推测雪碧图中的真实数字 得到数字列表</span><br>    num_list = predict(single_bit_images, model)<br><br>    <span class="hljs-comment"># 根据列表和有几位数字获得真实数字集合</span><br>    num_list = mix_num(num_list, count_bit)<br>    <span class="hljs-comment"># print(f&#x27;第 &#123;page_num&#125; 页的每个数字: &#x27;, num_list)</span><br><br>    <span class="hljs-keyword">return</span> num_list<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    判断预测是否精确</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">is_accurate</span>(<span class="hljs-params">predicts</span>):<br>    <span class="hljs-comment"># = =, 模型判断率挺高的了(都42w训练集了), 同一页请求的前三次都相同直接就返回了(即判定准确结果都还有错) 难道存在连续3次都判错的可能?</span><br>    <span class="hljs-comment"># if len(predicts) &lt; 3:</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(predicts) &lt; <span class="hljs-number">6</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    predicts_set = <span class="hljs-built_in">set</span>(predicts)<br>    <span class="hljs-comment"># 看预测结果出现的频率 认定出现频率 &gt;= 2/3 那么这个数才是准确的(因为本身模型确认率虽然接近100% 但不是100%)</span><br>    <span class="hljs-comment"># 统计 &#123; 数字: 出现的次数 &#125;</span><br>    statistics = &#123;num: predicts.count(num) <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> predicts_set&#125;<br><br>    <span class="hljs-comment"># 值逆序排列 返回列表 一对键值混合为元组</span><br>    statistics = <span class="hljs-built_in">sorted</span>(statistics.items(), key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">1</span>], reverse=<span class="hljs-literal">True</span>)<br>    <span class="hljs-comment"># 值最大的元组 的第二个元素 才是 频数, 元组第一个是数字和</span><br>    <span class="hljs-comment"># 不用这个条件了 = =, 太多预测错误的就会一直卡在当前页了 永远达不到这个比例</span><br>    <span class="hljs-comment"># if statistics[0][1] / len(predicts) &gt;= 3 / 4:</span><br><br>    <span class="hljs-comment"># 采用 只有频率1出现 or 频率top1 / top2 &gt; n 我觉得4够高了啊</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(statistics) == <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> statistics[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] / statistics[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] &gt; <span class="hljs-number">4</span>:<br>        <span class="hljs-built_in">print</span>(statistics)<br>        <span class="hljs-keyword">return</span> statistics[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    total = <span class="hljs-number">0</span><br><br>    <span class="hljs-comment"># 模型文件路径</span><br>    model_path = <span class="hljs-string">&#x27;./sprite-image-2-test/glided_sky_model/glided_sky_model.h5&#x27;</span><br>    <span class="hljs-comment"># 加载模型(放到函数里加载报WARNING, 解决不了: ARNING:tensorflow:6 out of the last 11 calls to &lt;function</span><br>    <span class="hljs-comment">#       Model.make_predict_function.)</span><br>    restored_model = keras.models.load_model(model_path)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1001</span>):<br>        <span class="hljs-comment"># 当前页的预测值集合</span><br>        predicts = []<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span> * <span class="hljs-number">100</span>)<br>        <span class="hljs-comment"># 结果是否准确</span><br>        accurate = is_accurate(predicts)<br>        count = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> accurate:<br>            count += <span class="hljs-number">1</span><br>            <span class="hljs-comment"># 不精确 就重新请求</span><br>            num_list = get_num_list(i, restored_model)<br>            predicts.append(<span class="hljs-built_in">sum</span>(num_list))<br>            accurate = is_accurate(predicts)<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;经过 <span class="hljs-subst">&#123;count&#125;</span> 轮计算, 结果才精确!!!&#x27;</span>)<br>        <span class="hljs-comment"># 判断数值是否精确 这里accurate是int64的, 源于用模型预测时 np.argmax() 结果是 int64</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;第 <span class="hljs-subst">&#123;i&#125;</span> 页数据为: <span class="hljs-subst">&#123;num_list&#125;</span>, 求和是 <span class="hljs-subst">&#123;accurate&#125;</span>&#x27;</span>)<br><br>        total += accurate<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;前 <span class="hljs-subst">&#123;i&#125;</span> 页, 数字和为 <span class="hljs-subst">&#123;total&#125;</span>&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span> * <span class="hljs-number">100</span>)<br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    page1 [337, 379, 263, 144, 131, 285, 381, 364, 291, 171, 110, 94]</span><br><span class="hljs-string">    page1 + page2 + page3 = 2956 + 2907 + 2844 = 8707</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    错误答案1: 2725233</span><br><span class="hljs-string">    错误答案2: 2724715</span><br><span class="hljs-string">    还真是出错出在连续三次都判定为错误答案!!! 修改为6次以上才判定就好了(多判定几组数据) (正确答案: 27247^_^)</span><br><span class="hljs-string">    之前还怀疑训练42w组数据都能出错 (*￣▽￣*)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">yincaiTA</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lsycai.top/glidedsky/">https://lsycai.top/glidedsky/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lsycai.top" target="_blank">yincaiTA' Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Python/">Python</a><a class="post-meta__tags" href="/tags/%E7%88%AC%E8%99%AB/">爬虫</a><a class="post-meta__tags" href="/tags/glidedsky/">glidedsky</a></div><div class="post_share"><div class="social-share" data-image="https://img.lsycai.top/cover/glidedsky.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/hexo-basics/"><img class="next-cover" src="/self/images/loading.gif" data-original="https://img.lsycai.top/cover/hexo-basics.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">hexo的基本使用</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/self/images/loading.gif" data-original="/self/images/author_avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">yincaiTA</div><div class="author-info__description">小善的学习笔记 🐟</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">4</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/yincaita" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%88%AC%E8%99%AB%E5%9F%BA%E7%A1%80-1"><span class="toc-number">1.</span> <span class="toc-text">爬虫基础-1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E9%A2%98"><span class="toc-number">1.1.</span> <span class="toc-text">第一题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%88%AC%E8%99%AB%E5%9F%BA%E7%A1%80-2"><span class="toc-number">2.</span> <span class="toc-text">爬虫基础-2</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IP%E5%B1%8F%E8%94%BD-1"><span class="toc-number">3.</span> <span class="toc-text">IP屏蔽-1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IP%E5%B1%8F%E8%94%BD-2"><span class="toc-number">4.</span> <span class="toc-text">IP屏蔽-2</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%97%E4%BD%93%E5%8F%8D%E7%88%AC-1"><span class="toc-number">5.</span> <span class="toc-text">字体反爬-1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%97%E4%BD%93%E5%8F%8D%E7%88%AC-2"><span class="toc-number">6.</span> <span class="toc-text">字体反爬-2</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CSS%E5%8F%8D%E7%88%AC-1"><span class="toc-number">7.</span> <span class="toc-text">CSS反爬-1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9B%AA%E7%A2%A7%E5%9B%BE%E5%8F%8D%E7%88%AC-1"><span class="toc-number">8.</span> <span class="toc-text">雪碧图反爬-1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%88%AC%E8%99%AB-%E9%AA%8C%E8%AF%81%E7%A0%81-1"><span class="toc-number">9.</span> <span class="toc-text">爬虫-验证码-1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%88%AC%E8%99%AB-JS%E5%8A%A0%E5%AF%861"><span class="toc-number">10.</span> <span class="toc-text">爬虫-JS加密1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%88%AC%E8%99%AB-%E9%AA%8C%E8%AF%81%E7%A0%81-2"><span class="toc-number">11.</span> <span class="toc-text">爬虫-验证码-2</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9B%AA%E7%A2%A7%E5%9B%BE%E5%8F%8D%E7%88%AC-2"><span class="toc-number">12.</span> <span class="toc-text">雪碧图反爬-2</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-number">12.1.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%87%E5%89%B2%E5%87%BA%E5%B0%8F%E5%9B%BE"><span class="toc-number">12.2.</span> <span class="toc-text">代码实现切割出小图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E8%AE%AD%E7%BB%83"><span class="toc-number">12.3.</span> <span class="toc-text">开始训练</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A0%81"><span class="toc-number">12.4.</span> <span class="toc-text">编码</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/spring-source-core-compile/" title="Spring源码编译"><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/cover/spring-source-compile.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spring源码编译"/></a><div class="content"><a class="title" href="/spring-source-core-compile/" title="Spring源码编译">Spring源码编译</a><time datetime="2022-01-10T08:33:46.000Z" title="发表于 2022-01-10 16:33:46">2022-01-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/butterfly-theme-config/" title="butterfly主题配置"><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/cover/hexo-butterfly-config.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="butterfly主题配置"/></a><div class="content"><a class="title" href="/butterfly-theme-config/" title="butterfly主题配置">butterfly主题配置</a><time datetime="2021-12-25T16:03:33.000Z" title="发表于 2021-12-26 00:03:33">2021-12-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/hexo-basics/" title="hexo的基本使用"><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/cover/hexo-basics.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="hexo的基本使用"/></a><div class="content"><a class="title" href="/hexo-basics/" title="hexo的基本使用">hexo的基本使用</a><time datetime="2021-12-25T15:31:55.000Z" title="发表于 2021-12-25 23:31:55">2021-12-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/glidedsky/" title="glidedsky网站爬虫练习"><img src="/self/images/loading.gif" data-original="https://img.lsycai.top/cover/glidedsky.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="glidedsky网站爬虫练习"/></a><div class="content"><a class="title" href="/glidedsky/" title="glidedsky网站爬虫练习">glidedsky网站爬虫练习</a><time datetime="2021-06-15T11:03:49.000Z" title="发表于 2021-06-15 19:03:49">2021-06-15</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://img.lsycai.top/cover/glidedsky.png')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By yincaiTA</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body></html>